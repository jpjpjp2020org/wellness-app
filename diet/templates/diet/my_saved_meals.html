{% load static %}
{% load diet_extras %}

<div class="saved-meals-container">
    <div class="navigation-buttons">
        <a href="{% url 'diet:specific_meals' %}" class="button outline">‚Üê Back to Meal Planning</a>
    </div>

    <h1>My Saved Meals Dashboard</h1>

    <div class="page-actions" style="margin-bottom: 20px; display: flex; gap: 12px;">
        <button onclick="openCustomMealModal()" class="button primary">
            + Add a Custom Meal
        </button>
        <button onclick="openAiRecipeModal()" class="button" style="background: #845ef7; color: #fff;">
            + Add Random Meal by AI
        </button>
    </div>

    {% csrf_token %}

    {% if adjusted_wellness_score %}
    <div class="wellness-score-summary" style="background: #e6fcf5; border: 1px solid #63e6be; border-radius: 8px; padding: 18px; margin-bottom: 18px;">
        <h2 style="color: #099268; margin-bottom: 8px;">Your Wellness Score (Nutrition-Adjusted)</h2>
        <div style="font-size: 1.3em; margin-bottom: 6px;">
            <strong>{{ adjusted_wellness_score }}</strong> <span style="font-size: 0.8em; color: #868e96;">(Base: {{ base_wellness_score }})</span>
        </div>
        <div style="font-size: 1em; color: #20c997;">
            Nutrition Adherence Ratio: <strong>{{ adherence_ratio }}</strong>
        </div>
        <div style="font-size: 0.95em; color: #868e96; margin-top: 6px;">
            <em>This score is boosted or reduced based on how closely your 7-day meal plan matches your calorie target. Staying close to your target improves your wellness score!</em>
        </div>
        <form method="post" action="{% url 'diet:regenerate_wellness_score' %}" style="margin-top: 14px;">
            {% csrf_token %}
            <button type="submit" class="button primary" style="margin-bottom: 6px;">Regenerate Score</button>
        </form>
        <div style="font-size: 0.95em; color: #099268; margin-top: 2px;">
            <strong>Tip:</strong> Once you have adjusted your meal plan, click 'Regenerate Score' to update your wellness score.
        </div>
        {% if debug_total_calories and debug_week_target and debug_diff %}
        <div style="font-size: 0.95em; color: #495057; margin-top: 8px;">
            <strong>Debug:</strong> 7-day Total Calories: <strong>{{ debug_total_calories }}</strong> &nbsp;|&nbsp; 7-day Target: <strong>{{ debug_week_target }}</strong> &nbsp;|&nbsp; Difference: <strong>{{ debug_diff }}</strong>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    {% if meal_analysis %}
    <div class="nutrition-analysis">
        <h2>Your Nutrition Plan</h2>
        <div class="analysis-grid">
            <div class="analysis-section">
                <h3>Daily Targets</h3>
                <p class="highlight">{{ meal_analysis.daily_calories }} calories per day</p>
                
                <h4>Macro Split</h4>
                <div class="macro-distribution">
                    <div class="macro">
                        <span class="macro-label">Protein</span>
                        <span class="macro-value">{{ meal_analysis.macro_split.protein }}%</span>
                    </div>
                    <div class="macro">
                        <span class="macro-label">Carbs</span>
                        <span class="macro-value">{{ meal_analysis.macro_split.carbs }}%</span>
                    </div>
                    <div class="macro">
                        <span class="macro-label">Fats</span>
                        <span class="macro-value">{{ meal_analysis.macro_split.fats }}%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- AI Nutritional Analysis Section (Isolated) -->
    <div id="ai-nutritional-analysis" style="margin: 20px 0; padding: 18px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h2 style="color: #856404; margin: 0;">AI Nutritional Analysis</h2>
            <button id="generate-analysis-btn" class="button primary" style="padding: 8px 16px; font-size: 0.9em;">
                üîÑ Generate Analysis
            </button>
        </div>
        
        <div id="analysis-loading" style="display: none; text-align: center; padding: 20px;">
            <div style="color: #856404;">Generating AI analysis...</div>
        </div>
        
        <div id="analysis-content" style="display: none;">
            <div id="analysis-text" style="color: #495057; line-height: 1.6; white-space: pre-line;"></div>
        </div>
        
        <div id="analysis-error" style="display: none; color: #721c24; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 10px; margin-top: 10px;">
            <strong>Error:</strong> <span id="error-message"></span>
        </div>
        
        <div style="font-size: 0.9em; color: #856404; margin-top: 8px;">
            <em>This analysis provides insights based on your current 7-day meal plan and nutrition targets. Click "Generate Analysis" to get personalized recommendations.</em>
        </div>
    </div>
    
    <!-- Debug: Show raw allergies/dislikes -->
    <!-- {% if prefs %}
    <div style="color: #b22222; font-size: 0.95em; margin-bottom: 4px;">
        DEBUG allergies: {{ prefs.allergies }} | dislikes: {{ prefs.dislikes }}
    </div>
    {% endif %} -->
    
    <!-- Isolated User Dietary Info for Filtering -->
    {% if prefs and prefs.allergies or prefs and prefs.dislikes %}
    <div id="user-dietary-info" style="margin: 20px 0; padding: 12px; background: #f3f0ff; border: 1px solid #b197fc; border-radius: 8px;">
        <h4 style="margin-bottom: 6px; color: #5f3dc4;">Your Dietary Restrictions</h4>
        {% if prefs.allergies %}
        <div><strong>Allergies:</strong> <span id="user-allergies">{{ prefs.allergies|join:", " }}</span></div>
        {% endif %}
        {% if prefs.dislikes %}
        <div><strong>Dislikes:</strong> <span id="user-dislikes">{{ prefs.dislikes|join:", " }}</span></div>
        {% endif %}
    </div>
    {% endif %}
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    {% if total_count > 0 %}
        <div class="collection-summary">
            <p class="meal-count">You have <strong>{{ total_count }}</strong> saved meal{{ total_count|pluralize }}</p>
        </div>

        <!-- Filter UI Section -->
        <div id="meal-filter-ui" style="margin-bottom: 24px; padding: 16px; background: #e7f5ff; border: 1px solid #74c0fc; border-radius: 8px;">
            <h4 style="color: #1971c2; margin-bottom: 10px;">Filter Your Saved Meals</h4>
            <form id="meal-filter-form" onsubmit="return false;" style="display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end;">
                <div>
                    <label>Ingredient:</label><br>
                    <input type="text" id="filter-ingredient" placeholder="e.g. chicken" style="width: 120px;">
                </div>
                <div>
                    <label>Calories:</label><br>
                    <input type="number" id="filter-min-cal" placeholder="Min" style="width: 60px;"> -
                    <input type="number" id="filter-max-cal" placeholder="Max" style="width: 60px;">
                </div>
                <div>
                    <label>Protein (g):</label><br>
                    <input type="number" id="filter-min-protein" placeholder="Min" style="width: 60px;"> -
                    <input type="number" id="filter-max-protein" placeholder="Max" style="width: 60px;">
                </div>
                <div>
                    <label>Carbs (g):</label><br>
                    <input type="number" id="filter-min-carbs" placeholder="Min" style="width: 60px;"> -
                    <input type="number" id="filter-max-carbs" placeholder="Max" style="width: 60px;">
                </div>
                <div>
                    <label>Fat (g):</label><br>
                    <input type="number" id="filter-min-fat" placeholder="Min" style="width: 60px;"> -
                    <input type="number" id="filter-max-fat" placeholder="Max" style="width: 60px;">
                </div>
                <div>
                    <label>Prep Time (min):</label><br>
                    <input type="number" id="filter-min-prep" placeholder="Min" style="width: 60px;"> -
                    <input type="number" id="filter-max-prep" placeholder="Max" style="width: 60px;">
                </div>
                <div>
                    <label>Allergies/Dislikes:</label><br>
                    <select id="filter-allergy" multiple style="min-width: 120px; max-width: 180px;">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div>
                    <button type="button" id="apply-meal-filters" class="button primary" style="margin-top: 4px;">Filter Meals</button>
                    <button type="button" id="reset-meal-filters" class="button outline" style="margin-top: 4px; margin-left: 6px;">Reset</button>
                </div>
            </form>
        </div>

        <!-- Static Meal Planning Structure -->
        <div class="static-planning-window">
            <h3>Current Meal Plan Structure</h3>
            
            <!-- Meal Management Controls -->
            <div class="meal-management-controls" style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 1px solid #90caf9;">
                <h4 style="margin: 0 0 10px 0; color: #1976d2;">Meal Plan Management</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="openMealPlanningMode('swap')" class="button warning" style="padding: 8px 16px; font-size: 0.9em;">
                        üîÑ Swap Meals
                    </button>
                    <button onclick="openMealPlanningMode('remove')" class="button danger" style="padding: 8px 16px; font-size: 0.9em;">
                        üóëÔ∏è Remove Meals
                    </button>
                    <span style="font-size: 0.85em; color: #1976d2; align-self: center;">
                        Click to manage your meal plan
                    </span>
                </div>
            </div>
            
            <!-- Versioning Controls (Isolated) -->
            <div class="versioning-controls" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0; color: #495057;">Meal Plan Versions</h4>
                    <button onclick="createNewVersion()" class="button primary" style="padding: 8px 16px; font-size: 0.9em;">
                        Save Current Version
                    </button>
                </div>
                
                <div id="versions-dropdown-container" style="display: none;">
                    <label for="versions-dropdown" style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;">
                        Restore Previous Version:
                    </label>
                    <select id="versions-dropdown" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; margin-bottom: 10px;">
                        <option value="">Select a version to restore...</option>
                    </select>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="restoreSelectedVersion()" class="button primary" style="padding: 6px 12px; font-size: 0.85em;">
                            Restore Version
                        </button>
                        <button onclick="hideVersionsDropdown()" class="button outline" style="padding: 6px 12px; font-size: 0.85em;">
                            Cancel
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="showVersionsDropdown()" class="button outline" style="padding: 6px 12px; font-size: 0.85em;">
                        View All Versions
                    </button>
                    <span id="version-status" style="font-size: 0.85em; color: #6c757d; align-self: center;"></span>
                </div>
            </div>
            
            <div class="week-overview">
                {% for day in week_days %}
                <div class="day-column">
                    <div class="day-header">{{ day.date|date:"D, M d" }}</div>
                    <div class="meal-slots">
                        {% for slot in meal_slots %}
                        <div class="meal-slot" data-day="{{ day.formatted_date }}" data-meal="{{ slot }}">
                            <h4>{{ slot|capfirst }}</h4>
                            <div class="slot-content">
                                {% with planned=planned_meals|get_item:day.formatted_date|get_item:slot %}
                                    {% if planned and planned.meal_name %}
                                        <div class="planned-meal">
                                            <img src="{{ planned.meal_thumb }}" alt="{{ planned.meal_name }}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
                                            <span>{{ planned.meal_name }}</span>
                                            
                                            <!-- Portion Adjustment Controls -->
                                            <div class="portion-controls" style="margin-top: 8px; padding: 5px; background: #f8f9fa; border-radius: 4px; font-size: 0.8em;">
                                                <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 3px;">
                                                    <label style="font-weight: 500; color: #495057;">Portion:</label>
                                                    <select class="portion-selector" 
                                                            data-date="{{ day.formatted_date }}" 
                                                            data-meal="{{ slot }}" 
                                                            data-meal-id="{{ planned.saved_meal_id }}"
                                                            style="padding: 2px 4px; border: 1px solid #ced4da; border-radius: 3px; font-size: 0.8em;">
                                                        <option value="0.5" {% if planned.portion_multiplier == 0.5 %}selected{% endif %}>0.5x</option>
                                                        <option value="0.75" {% if planned.portion_multiplier == 0.75 %}selected{% endif %}>0.75x</option>
                                                        <option value="1.0" {% if planned.portion_multiplier == 1.0 or not planned.portion_multiplier %}selected{% endif %}>1.0x</option>
                                                        <option value="1.25" {% if planned.portion_multiplier == 1.25 %}selected{% endif %}>1.25x</option>
                                                        <option value="1.5" {% if planned.portion_multiplier == 1.5 %}selected{% endif %}>1.5x</option>
                                                        <option value="2.0" {% if planned.portion_multiplier == 2.0 %}selected{% endif %}>2.0x</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <!-- Daily Totals Row -->
                    <div class="daily-totals">
                        <h4>Daily Totals</h4>
                        <div class="totals-content">
                            {% with day_meals=planned_meals|get_item:day.formatted_date %}
                                {% if day_meals %}
                                    {% with totals=day_meals|calculate_daily_totals %}
                                        <div class="totals-grid">
                                            <div class="total-item">
                                                <span class="total-label">Calories</span>
                                                <span class="total-value">{{ totals.calories|floatformat:1|default:0 }} kcal</span>
                                                {% if meal_analysis %}
                                                    <span class="target-comparison {% if totals.calories > meal_analysis.daily_calories %}over{% elif totals.calories < meal_analysis.daily_calories %}under{% endif %}">
                                                        ({{ totals.calories|subtract:meal_analysis.daily_calories|floatformat:1 }} kcal)
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <div class="total-item">
                                                <span class="total-label">Protein</span>
                                                <span class="total-value">{{ totals.protein|floatformat:1|default:0 }}g</span>
                                            </div>
                                            <div class="total-item">
                                                <span class="total-label">Carbs</span>
                                                <span class="total-value">{{ totals.carbs|floatformat:1|default:0 }}g</span>
                                            </div>
                                            <div class="total-item">
                                                <span class="total-label">Fat</span>
                                                <span class="total-value">{{ totals.fats|floatformat:1|default:0 }}g</span>
                                            </div>
                                        </div>
                                    {% endwith %}
                                {% else %}
                                    <div class="no-meals-message">No meals planned for this day</div>
                                {% endif %}
                            {% endwith %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Shopping List Button -->
        <div class="shopping-list-actions" style="margin: 20px 0; text-align: center;">
            <button onclick="generateShoppingList()" class="button primary" style="padding: 10px 20px; font-size: 1.1em;">
                Generate Shopping List
            </button>
        </div>

        

        <div class="saved-meals-grid">
            {% for meal in saved_meals %}
            <div class="saved-meal-card">
                {% if meal.source != 'Custom' and meal.meal_thumb %}
                <img src="{{ meal.meal_thumb }}" alt="{{ meal.meal_name }}" class="meal-image">
                {% endif %}
                <div class="meal-info">
                    <h3 class="meal-title">{{ meal.meal_name }}</h3>
                    <div class="meal-meta">
                        <span class="meal-category">{{ meal.category }}</span>
                        {% if meal.area %}
                            <span class="meal-area">{{ meal.area }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="meal-ingredients-preview">
                        <strong>Ingredients:</strong>
                        {% with ingredients=meal.get_ingredients_list %}
                            {% for ing in ingredients|slice:":3" %}
                                {{ ing.ingredient }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                            {% if ingredients|length > 3 %}...{% endif %}
                        {% endwith %}
                    </div>

                    <div class="meal-macros">
                        {% if meal.macros_json %}
                        <div class="text-sm text-gray-600 mb-2">
                            <p>{{ meal.macros_json.calories|floatformat:0 }} kcal</p>
                            <p>P: {{ meal.macros_json.protein|floatformat:1 }}g | C: {{ meal.macros_json.carbs|floatformat:1 }}g | F: {{ meal.macros_json.fat|floatformat:1 }}g</p>
                            {% if meal.recommended_servings %}
                            <p class="text-blue-600">Recommended: {{ meal.recommended_servings }} serving{{ meal.recommended_servings|pluralize }}</p>
                            {% else %}
                            <button data-meal-id="{{ meal.id }}" class="update-nutrition-btn text-xs text-green-600 hover:text-green-800">
                                Get recommended servings
                            </button>
                            {% endif %}
                            {% if meal.prep_time_min %}
                            <p class="text-purple-700">Prep time: {{ meal.prep_time_min|floatformat:0 }} min</p>
                            {% else %}
                            <button data-meal-id="{{ meal.id }}" class="update-preptime-btn text-xs text-purple-700 hover:text-purple-900">
                                Get Prep Time
                            </button>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="nutrition-actions">
                            <button data-meal-id="{{ meal.id }}" class="update-nutrition-btn text-sm text-blue-600 hover:text-blue-800">
                                Get macros
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="meal-actions">
                        <button class="action-btn view-btn" onclick="toggleMealDetails('{{ meal.id }}')">
                            View Details
                        </button>
                        <button class="action-btn plan-btn" onclick="openMealPlanning('{{ meal.id }}', '{{ meal.meal_name }}', '{{ meal.meal_thumb }}')">
                            Add to Plan
                        </button>
                        <button data-meal-id="{{ meal.id }}" class="action-btn delete-btn">
                            Delete
                        </button>
                        {% if meal.favorite %}
                            <span class="favorite-indicator">‚≠ê Favorite</span>
                        {% endif %}
                    </div>
                    
                    <div class="meal-metadata">
                        <span class="saved-date">Saved: {{ meal.saved_at|date:"M d, Y" }}</span>
                    </div>
                </div>
                
                <!-- Chart Visualization Section -->
                {% if meal.macros_json and meal.macros_json.calories and meal.recommended_servings > 0 and meal_analysis.daily_calories %}
                <div class="meal-charts-container" 
                     style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;"
                     data-meal-id="{{ meal.id }}"
                     data-calories-per-serving="{{ meal.macros_json.calories|divide:meal.recommended_servings }}"
                     data-daily-target="{{ meal_analysis.daily_calories }}"
                     data-protein="{{ meal.macros_json.protein|default:0 }}"
                     data-carbs="{{ meal.macros_json.carbs|default:0 }}"
                     data-fat="{{ meal.macros_json.fat|default:0 }}">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: space-around;">
                        <div style="flex: 1; min-width: 250px;">
                            <canvas id="calorie-chart-{{ meal.id }}"></canvas>
                        </div>
                        <div style="flex: 1; min-width: 250px; max-width: 300px;">
                            <canvas id="macro-chart-{{ meal.id }}"></canvas>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="meal-details-full" id="details-{{ meal.id }}" style="display: none;">
                    <div class="ingredients-section">
                        <h4>Ingredients</h4>
                        <div class="ingredients-list">
                            {% for ing in meal.get_ingredients_list %}
                            <div class="ingredient-item">
                                <span class="ingredient-name">{{ ing.ingredient }}</span>
                                <span class="ingredient-measure">{{ ing.measure }}</span>
                                <button class="substitute-btn" data-ingredient="{{ ing.ingredient }}" data-meal-id="{{ meal.id }}" style="margin-left: 8px; font-size: 0.85em; padding: 2px 8px; border-radius: 4px; background: #845ef7; color: #fff; border: none; cursor: pointer;">Substitute</button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="instructions-section">
                        <h4>Instructions</h4>
                        <div class="instructions-text">
                            {{ meal.instructions|linebreaks }}
                        </div>
                    </div>
                    
                    {% if meal.youtube_link or meal.source_link %}
                    <div class="external-links">
                        {% if meal.youtube_link %}
                            <a href="{{ meal.youtube_link }}" target="_blank" class="external-link youtube-link">
                                üì∫ Watch on YouTube
                            </a>
                        {% endif %}
                        {% if meal.source_link %}
                            <a href="{{ meal.source_link }}" target="_blank" class="external-link source-link">
                                üîó View Original Source
                            </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-collection">
            <div class="empty-state">
                <h2>No saved meals yet</h2>
                <p>Start building your meal collection by searching for recipes and clicking "Save Recipe"</p>
                <a href="{% url 'diet:specific_meals' %}" class="button primary">Search for Recipes</a>
            </div>
        </div>
    {% endif %}
</div>

{% include "diet/meal_planning_modal.html" %}

<!-- Custom Meal Modal -->
<div id="custom-meal-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2 id="custom-meal-modal-title">Add a Custom Meal</h2>
            <span class="close-modal">&times;</span>
        </div>
        
        <form id="custom-meal-form">
            <!-- Step 1: Initial Data Entry -->
            <div id="custom-meal-form-step1">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="meal_name">Meal Name</label>
                            <input type="text" id="meal_name" name="meal_name" required>
                        </div>
                        <div class="form-group">
                            <label for="category">Category</label>
                            <input type="text" id="category" name="category" placeholder="e.g., Dinner, Dessert" required>
                        </div>
                        <div class="form-group">
                            <label for="area">Cuisine / Area</label>
                            <input type="text" id="area" name="area" placeholder="e.g., Italian, Mexican">
                        </div>
                        <div class="form-group full-width">
                            <label for="ingredients">Ingredients</label>
                            <textarea id="ingredients" name="ingredients" rows="6" placeholder="One ingredient per line. e.g.&#10;1 cup flour&#10;2 large eggs&#10;100g dark chocolate" required></textarea>
                            <small>Enter one ingredient per line. The AI will parse this to calculate nutrition.</small>
                        </div>
                        <div class="form-group full-width">
                            <label for="instructions">Instructions</label>
                            <textarea id="instructions" name="instructions" rows="8" required></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button outline" id="cancel-custom-meal">Cancel</button>
                    <button type="submit" class="button primary">Analyze Ingredients</button>
                </div>
            </div>

            <!-- Step 2: Ingredient Confirmation -->
            <div id="custom-meal-form-step2" style="display: none;">
                <div class="modal-body">
                    <h4>Confirm Ingredients</h4>
                    <p>The AI has interpreted your ingredients. Please select the most accurate option.</p>
                    <div id="ingredient-choices-container">
                        <!-- Choices will be injected here by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button outline" id="back-to-form">Back</button>
                    <button type="button" class="button primary" id="confirm-final-save">Confirm and Save</button>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
.saved-meals-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.navigation-buttons {
    margin-bottom: 20px;
    padding: 10px 0;
}

.button.outline {
    background: transparent;
    border: 2px solid #6c757d;
    color: #6c757d;
    text-decoration: none;
    padding: 8px 16px;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.button.outline:hover {
    background: #6c757d;
    color: white;
}

.button.primary {
    background: #007bff;
    color: white;
    text-decoration: none;
    padding: 10px 20px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: background 0.3s ease;
}

.button.primary:hover {
    background: #0056b3;
}

.collection-summary {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.meal-count {
    margin: 0;
    font-size: 1.1em;
    color: #495057;
}

.saved-meals-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
}

.saved-meal-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.saved-meal-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.meal-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
}

.meal-info {
    padding: 15px;
}

.meal-title {
    margin: 0 0 10px 0;
    color: #212529;
    font-size: 1.2em;
}

.meal-meta {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.meal-category, .meal-area {
    background: #e9ecef;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.85em;
    color: #495057;
}

.meal-ingredients-preview {
    font-size: 0.9em;
    color: #6c757d;
    margin-bottom: 15px;
    line-height: 1.4;
}

.meal-macros {
    margin-top: 10px;
    font-size: 0.95em;
    color: #333;
}

.macros-list {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.get-macros-btn {
    background: #ffc107;
    color: #212529;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.95em;
    margin-top: 5px;
    transition: background 0.2s;
}

.get-macros-btn:hover {
    background: #e0a800;
}

.meal-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.action-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    transition: background 0.2s ease;
}

.action-btn:hover {
    background: #0056b3;
}

.favorite-indicator {
    font-size: 0.9em;
    color: #ffc107;
}

.meal-metadata {
    font-size: 0.8em;
    color: #6c757d;
    border-top: 1px solid #dee2e6;
    padding-top: 10px;
}

.meal-details-full {
    border-top: 1px solid #dee2e6;
    padding: 15px;
    background: #f8f9fa;
}

.ingredients-section, .instructions-section {
    margin-bottom: 20px;
}

.ingredients-section h4, .instructions-section h4 {
    margin: 0 0 10px 0;
    color: #343a40;
}

.ingredients-list {
    display: grid;
    grid-template-columns: 1fr;
    gap: 5px;
}

.ingredient-item {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px solid #dee2e6;
}

.ingredient-name {
    font-weight: 500;
}

.ingredient-measure {
    color: #6c757d;
    font-style: italic;
}

.instructions-text {
    line-height: 1.6;
    color: #495057;
}

.external-links {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.external-link {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.9em;
    transition: all 0.2s ease;
}

.youtube-link {
    background: #ff0000;
    color: white;
}

.youtube-link:hover {
    background: #cc0000;
}

.source-link {
    background: #6c757d;
    color: white;
}

.source-link:hover {
    background: #5a6268;
}

.empty-collection {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 400px;
}

.empty-state {
    text-align: center;
    color: #6c757d;
}

.empty-state h2 {
    color: #495057;
    margin-bottom: 10px;
}

@media (max-width: 768px) {
    .saved-meals-grid {
        grid-template-columns: 1fr;
    }
    
    .meal-actions {
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
    }
}

.plan-btn {
    background: #28a745;
}

.plan-btn:hover {
    background: #218838;
}

.action-btn {
    margin-right: 8px;
}

/* Static Planning Window Styles */
.static-planning-window {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 30px;
}

.static-planning-window h3 {
    margin: 0 0 20px 0;
    color: #212529;
    font-size: 1.3em;
}

/* Debug Data Dump Styles */
.debug-data-dump {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
    font-family: monospace;
}

.debug-data-dump h3 {
    margin: 0 0 20px 0;
    color: #212529;
    font-size: 1.3em;
}

.data-section {
    margin-bottom: 20px;
}

.data-section h4 {
    margin: 0 0 10px 0;
    color: #495057;
    font-size: 1.1em;
}

.data-section pre {
    background: #e9ecef;
    padding: 15px;
    border-radius: 4px;
    overflow-x: auto;
    margin: 0;
    font-size: 0.9em;
    color: #212529;
}

/* Nutrition Analysis Styles */
.nutrition-analysis {
    background: white;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin: 30px 0;
}

.analysis-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.analysis-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 5px;
}

.highlight {
    font-size: 1.5em;
    color: #007bff;
    font-weight: 500;
    margin: 10px 0;
}

.macro-distribution {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 15px;
}

.macro {
    text-align: center;
    padding: 10px;
    background: white;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.macro-label {
    display: block;
    color: #6c757d;
    font-size: 0.9em;
}

.macro-value {
    display: block;
    font-size: 1.2em;
    font-weight: 500;
    color: #212529;
}

/* Daily Totals Styles */
.daily-totals {
    margin-top: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.daily-totals h4 {
    margin: 0 0 10px 0;
    color: #343a40;
    font-size: 1em;
}

.totals-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.total-item {
    display: flex;
    flex-direction: column;
    padding: 8px;
    background: white;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.total-label {
    color: #6c757d;
    font-size: 0.9em;
}

.total-value {
    font-weight: 500;
    color: #212529;
    font-size: 1.1em;
}

.target-comparison {
    font-size: 0.85em;
    color: #6c757d;
}

.target-comparison.over {
    color: #dc3545;
}

.target-comparison.under {
    color: #28a745;
}

.no-meals-message {
    text-align: center;
    color: #6c757d;
    font-style: italic;
    padding: 10px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .totals-grid {
        grid-template-columns: 1fr;
    }
    
    .macro-distribution {
        grid-template-columns: 1fr;
    }
}

/* Add styles for the new form */
.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}
.form-group {
    display: flex;
    flex-direction: column;
}
.form-group.full-width {
    grid-column: 1 / -1;
}
.form-group label {
    margin-bottom: 5px;
    font-weight: 500;
}
.form-group input[type="text"],
.form-group textarea {
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 1em;
}
.form-group small {
    margin-top: 5px;
    color: #6c757d;
    font-size: 0.85em;
}

.ingredient-choice {
    margin-bottom: 15px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px;
}
.ingredient-choice label {
    display: block;
    cursor: pointer;
}
.ingredient-choice input[type="radio"] {
    margin-right: 10px;
}
.ingredient-choice ul {
    list-style-type: disc;
    padding-left: 20px;
    margin-top: 5px;
}
</style>

<script>
// Global variables for meal planning
let selectedSlot = null;
let currentMealId = null;
let currentMode = 'add'; // 'add', 'swap', 'remove'
let swapSource = null;
let swapTarget = null;

function openMealPlanning(mealId, mealName, mealThumb) {
    currentMealId = mealId;
    currentMode = 'add';
    
    // Update modal content
    document.getElementById('modal-title').textContent = 'Add to Meal Plan';
    document.getElementById('modal-meal-name').textContent = mealName;
    document.getElementById('modal-meal-image').src = mealThumb;
    document.getElementById('meal-info-preview').style.display = 'flex';
    
    // Reset mode selection
    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.mode-btn[data-mode="add"]').classList.add('active');
    
    // Show/hide instructions
    document.getElementById('swap-instructions').style.display = 'none';
    document.getElementById('remove-instructions').style.display = 'none';
    
    // Show/hide buttons
    document.getElementById('confirm-planning').style.display = 'inline-block';
    document.getElementById('confirm-swap').style.display = 'none';
    document.getElementById('confirm-remove').style.display = 'none';
    
    // Reset slot selections
    resetSlotSelections();
    
    document.getElementById('meal-planning-modal').style.display = 'block';
}

function openMealPlanningMode(mode) {
    currentMode = mode;
    currentMealId = null;
    
    // Update modal content
    document.getElementById('modal-title').textContent = mode === 'swap' ? 'Swap Meals' : 'Remove Meals';
    document.getElementById('meal-info-preview').style.display = 'none';
    
    // Update mode selection
    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.mode-btn[data-mode="${mode}"]`).classList.add('active');
    
    // Show/hide instructions
    document.getElementById('swap-instructions').style.display = mode === 'swap' ? 'block' : 'none';
    document.getElementById('remove-instructions').style.display = mode === 'remove' ? 'block' : 'none';
    
    // Show/hide buttons
    document.getElementById('confirm-planning').style.display = 'none';
    document.getElementById('confirm-swap').style.display = mode === 'swap' ? 'inline-block' : 'none';
    document.getElementById('confirm-remove').style.display = mode === 'remove' ? 'inline-block' : 'none';
    
    // Reset slot selections
    resetSlotSelections();
    
    document.getElementById('meal-planning-modal').style.display = 'block';
}

function resetSlotSelections() {
    selectedSlot = null;
    swapSource = null;
    swapTarget = null;
    
    // Remove all selection classes
    document.querySelectorAll('.meal-slot').forEach(slot => {
        slot.classList.remove('selected', 'swap-source', 'swap-target', 'remove-target');
    });
}

function selectMealSlot(slot) {
    if (currentMode === 'add') {
        // Standard selection for adding meals
        if (selectedSlot) {
            selectedSlot.classList.remove('selected');
        }
        selectedSlot = slot;
        slot.classList.add('selected');
    } else if (currentMode === 'swap') {
        // Two-step selection for swapping
        if (!swapSource) {
            // First selection - source
            swapSource = slot;
            slot.classList.add('swap-source');
        } else if (swapSource === slot) {
            // Deselect source
            swapSource.classList.remove('swap-source');
            swapSource = null;
        } else if (!swapTarget) {
            // Second selection - target
            swapTarget = slot;
            slot.classList.add('swap-target');
        } else if (swapTarget === slot) {
            // Deselect target
            swapTarget.classList.remove('swap-target');
            swapTarget = null;
        } else {
            // Change target
            swapTarget.classList.remove('swap-target');
            swapTarget = slot;
            slot.classList.add('swap-target');
        }
    } else if (currentMode === 'remove') {
        // Single selection for removal
        if (selectedSlot) {
            selectedSlot.classList.remove('remove-target');
        }
        selectedSlot = slot;
        slot.classList.add('remove-target');
    }
}

async function addMealToPlan(mealId, date, mealType) {
    try {
        const response = await fetch('/diet/add-meal-to-plan/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                meal_id: mealId,
                date: date,
                meal_type: mealType
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // Update the slot content to show the meal
            const slotContent = selectedSlot.querySelector('.slot-content');
            slotContent.innerHTML = `
                <div class="planned-meal">
                    <img src="${data.data.meal_thumb}" alt="${data.data.meal_name}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
                    <span>${data.data.meal_name}</span>
                </div>
            `;
            
            // Show success message
            alert('Meal added to plan successfully!');
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('Error adding meal to plan:', error);
        alert('Error adding meal to plan: ' + error.message);
    }
}

async function swapMeals() {
    if (!swapSource || !swapTarget) {
        alert('Please select both source and target meal slots');
        return;
    }
    
    try {
        const response = await fetch('/diet/swap-meals/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                source_date: swapSource.dataset.day,
                source_meal_type: swapSource.dataset.meal,
                target_date: swapTarget.dataset.day,
                target_meal_type: swapTarget.dataset.meal
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            alert('Meals swapped successfully!');
            closeMealPlanning();
            window.location.reload(); // Force reload to show updated plan
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('Error swapping meals:', error);
        alert('Error swapping meals: ' + error.message);
    }
}

async function removeMealFromPlan() {
    if (!selectedSlot) {
        alert('Please select a meal slot to remove');
        return;
    }
    
    if (!confirm('Are you sure you want to remove the meal from this slot?')) {
        return;
    }
    
    try {
        const response = await fetch('/diet/remove-meal-from-plan/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                date: selectedSlot.dataset.day,
                meal_type: selectedSlot.dataset.meal
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // Clear the slot content
            const slotContent = selectedSlot.querySelector('.slot-content');
            slotContent.innerHTML = '';
            
            alert('Meal removed from plan successfully!');
            closeMealPlanning();
            window.location.reload(); // Force reload to show updated plan
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('Error removing meal from plan:', error);
        alert('Error removing meal from plan: ' + error.message);
    }
}

function closeMealPlanning() {
    document.getElementById('meal-planning-modal').style.display = 'none';
    resetSlotSelections();
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Close modal when clicking the X
    document.querySelector('.close-modal').addEventListener('click', closeMealPlanning);
    
    // Close modal when clicking Cancel
    document.getElementById('cancel-planning').addEventListener('click', closeMealPlanning);
    
    // Handle mode selection
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const mode = this.dataset.mode;
            if (mode === 'add' && currentMealId) {
                // Switch back to add mode with current meal
                openMealPlanning(currentMealId, 
                    document.getElementById('modal-meal-name').textContent,
                    document.getElementById('modal-meal-image').src);
            } else {
                openMealPlanningMode(mode);
            }
        });
    });
    
    // Handle meal slot selection
    document.querySelectorAll('.meal-slot').forEach(slot => {
        slot.addEventListener('click', () => selectMealSlot(slot));
    });
    
    // Handle portion size changes
    document.addEventListener('change', function(event) {
        if (event.target.classList.contains('portion-selector')) {
            const selector = event.target;
            const date = selector.dataset.date;
            const meal = selector.dataset.meal;
            const mealId = selector.dataset.mealId;
            const portionMultiplier = selector.value;
            
            adjustPortionSize(date, meal, mealId, portionMultiplier, selector);
        }
    });
    
    // Handle confirm buttons
    document.getElementById('confirm-planning').addEventListener('click', async function() {
        if (!selectedSlot || !currentMealId) {
            alert('Please select a meal slot first');
            return;
        }
        
        const day = selectedSlot.dataset.day;
        const mealType = selectedSlot.dataset.meal;
        
        await addMealToPlan(currentMealId, day, mealType);
        closeMealPlanning();
        window.location.reload(); // Force reload so the plan structure updates
    });
    
    document.getElementById('confirm-swap').addEventListener('click', swapMeals);
    document.getElementById('confirm-remove').addEventListener('click', removeMealFromPlan);

    // Add versioning status update
    updateVersionStatus('Ready to save versions');

    // Prep Time Backfill Handler
    document.querySelectorAll('.update-preptime-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const mealId = btn.getAttribute('data-meal-id');
            btn.disabled = true;
            btn.textContent = 'Loading...';
            fetch(`/diet/get-prep-time/${mealId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Accept': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Replace the button with the new prep time
                    const p = document.createElement('p');
                    p.className = 'text-purple-700';
                    p.textContent = `Prep time: ${parseInt(data.prep_time_min)} min`;
                    btn.parentNode.replaceChild(p, btn);
                } else {
                    btn.disabled = false;
                    btn.textContent = 'Get Prep Time';
                    alert(data.message || 'Failed to get prep time.');
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.textContent = 'Get Prep Time';
                alert('Error contacting server.');
            });
        });
    });

    // Populate allergies/dislikes multi-select
    const allergySelect = document.getElementById('filter-allergy');
    if (allergySelect) {
        const allergies = document.getElementById('user-allergies')?.textContent.split(',').map(s => s.trim()).filter(Boolean) || [];
        const dislikes = document.getElementById('user-dislikes')?.textContent.split(',').map(s => s.trim()).filter(Boolean) || [];
        const allOptions = Array.from(new Set([...allergies, ...dislikes]));
        allOptions.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt;
            option.textContent = opt;
            allergySelect.appendChild(option);
        });
    }

    function getMacroValue(meal, macro) {
        const macroDiv = meal.querySelector('.meal-macros');
        if (!macroDiv) return null;
        const text = macroDiv.textContent;
        const regexes = {
            calories: /([0-9]+) kcal/i,
            protein: /P: ([0-9.]+)g/i,
            carbs: /C: ([0-9.]+)g/i,
            fat: /F: ([0-9.]+)g/i,
            prep: /Prep time: ([0-9]+) min/i
        };
        const match = text.match(regexes[macro]);
        return match ? parseFloat(match[1]) : null;
    }

    function mealHasIngredient(meal, ingredient) {
        const ingList = meal.querySelector('.ingredients');
        if (!ingList) return false;
        return ingList.textContent.toLowerCase().includes(ingredient.toLowerCase());
    }

    function mealHasAllergy(meal, allergy) {
        const ingList = meal.querySelector('.ingredients');
        if (!ingList) return false;
        return ingList.textContent.toLowerCase().includes(allergy.toLowerCase());
    }

    document.getElementById('apply-meal-filters').addEventListener('click', function() {
        const ingredient = document.getElementById('filter-ingredient').value.trim().toLowerCase();
        const minCal = parseFloat(document.getElementById('filter-min-cal').value);
        const maxCal = parseFloat(document.getElementById('filter-max-cal').value);
        const minProtein = parseFloat(document.getElementById('filter-min-protein').value);
        const maxProtein = parseFloat(document.getElementById('filter-max-protein').value);
        const minCarbs = parseFloat(document.getElementById('filter-min-carbs').value);
        const maxCarbs = parseFloat(document.getElementById('filter-max-carbs').value);
        const minFat = parseFloat(document.getElementById('filter-min-fat').value);
        const maxFat = parseFloat(document.getElementById('filter-max-fat').value);
        const minPrep = parseFloat(document.getElementById('filter-min-prep').value);
        const maxPrep = parseFloat(document.getElementById('filter-max-prep').value);
        const selectedAllergies = Array.from(document.getElementById('filter-allergy').selectedOptions).map(o => o.value.toLowerCase());

        document.querySelectorAll('.saved-meal-card').forEach(function(card) {
            let show = true;
            // Ingredient filter (inclusive)
            if (ingredient && !mealHasIngredient(card, ingredient)) show = false;
            // Calories
            const cal = getMacroValue(card, 'calories');
            if (!isNaN(minCal) && (cal === null || cal < minCal)) show = false;
            if (!isNaN(maxCal) && (cal === null || cal > maxCal)) show = false;
            // Protein
            const protein = getMacroValue(card, 'protein');
            if (!isNaN(minProtein) && (protein === null || protein < minProtein)) show = false;
            if (!isNaN(maxProtein) && (protein === null || protein > maxProtein)) show = false;
            // Carbs
            const carbs = getMacroValue(card, 'carbs');
            if (!isNaN(minCarbs) && (carbs === null || carbs < minCarbs)) show = false;
            if (!isNaN(maxCarbs) && (carbs === null || carbs > maxCarbs)) show = false;
            // Fat
            const fat = getMacroValue(card, 'fat');
            if (!isNaN(minFat) && (fat === null || fat < minFat)) show = false;
            if (!isNaN(maxFat) && (fat === null || fat > maxFat)) show = false;
            // Prep time
            const prep = getMacroValue(card, 'prep');
            if (!isNaN(minPrep) && (prep === null || prep < minPrep)) show = false;
            if (!isNaN(maxPrep) && (prep === null || prep > maxPrep)) show = false;
            // Allergies/dislikes (inclusive: show if any selected allergy/dislike is present)
            if (selectedAllergies.length > 0) {
                let found = false;
                for (const allergy of selectedAllergies) {
                    if (mealHasAllergy(card, allergy)) {
                        found = true;
                        break;
                    }
                }
                if (!found) show = false;
            }
            card.style.display = show ? '' : 'none';
        });
    });

    document.getElementById('reset-meal-filters').addEventListener('click', function() {
        document.getElementById('meal-filter-form').reset();
        document.querySelectorAll('.saved-meal-card').forEach(function(card) {
            card.style.display = '';
        });
    });
});

async function adjustPortionSize(date, meal, mealId, portionMultiplier, selector) {
    // Keep a backup of the previous value in case of an error
    const previousValue = selector.dataset.previousValue || selector.value;
    selector.dataset.previousValue = portionMultiplier;

    try {
        const response = await fetch('/diet/adjust-portion-size/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                date: date,
                meal_type: meal,
                meal_id: mealId,
                portion_multiplier: portionMultiplier
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // No need to update nutrition display here anymore.
            // Just provide visual feedback and trigger a reload for the daily totals.
            
            // Show success feedback
            selector.style.backgroundColor = '#d4edda';
            setTimeout(() => {
                selector.style.backgroundColor = '';
                // Reload the page to see updated daily totals
                window.location.reload(); 
            }, 500); // A short delay to show feedback before reloading
            
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('Error adjusting portion size:', error);
        alert('Error adjusting portion size: ' + error.message);
        
        // Reset selector to previous value on error
        selector.value = previousValue;
    }
}

// Close modal when clicking outside
window.addEventListener('click', function(event) {
    const modal = document.getElementById('meal-planning-modal');
    if (event.target === modal) {
        closeMealPlanning();
    }
});

function toggleMealDetails(mealId) {
    const detailsDiv = document.getElementById(`details-${mealId}`);
    const button = document.querySelector(`#details-${mealId}`).previousElementSibling.querySelector('.view-btn');
    
    if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
        button.textContent = 'Hide Details';
    } else {
        detailsDiv.style.display = 'none';
        button.textContent = 'View Details';
    }
}

function updateMealNutrition(mealId) {
    const button = document.querySelector(`.update-nutrition-btn[data-meal-id='${mealId}']`);
    const nutritionDiv = button.closest('.meal-macros');

    button.textContent = 'Getting info...';
    button.disabled = true;

    fetch(`/diet/get-meal-macros/${mealId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const macros = data.macros;
            const servings = data.servings;
            
            let html = `
                <div class="text-sm text-gray-600 mb-2">
                    <p>${macros.calories.toFixed(0)} kcal</p>
                    <p>P: ${macros.protein.toFixed(1)}g | C: ${macros.carbs.toFixed(1)}g | F: ${macros.fat.toFixed(1)}g</p>
            `;

            if (servings) {
                html += `<p class="text-blue-600">Recommended: ${servings} serving${servings > 1 ? 's' : ''}</p>`;
            }
            
            html += `</div>`;
            nutritionDiv.innerHTML = html;
        } else {
            button.textContent = 'Error! Retry?';
            button.disabled = false;
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        button.textContent = 'Error! Retry?';
        button.disabled = false;
        alert('An unexpected error occurred.');
    });
}

// Use event delegation for the nutrition buttons
document.querySelector('.saved-meals-grid').addEventListener('click', function(event) {
    // Handle nutrition update clicks
    if (event.target && event.target.classList.contains('update-nutrition-btn')) {
        const mealId = event.target.getAttribute('data-meal-id');
        updateMealNutrition(mealId);
    }

    // Handle delete button clicks
    if (event.target && event.target.classList.contains('delete-btn')) {
        const mealId = event.target.getAttribute('data-meal-id');
        const mealCard = event.target.closest('.saved-meal-card');
        
        if (confirm('Are you sure you want to delete this meal? This cannot be undone.')) {
            deleteSavedMeal(mealId, mealCard);
        }
    }
});

function deleteSavedMeal(mealId, mealCard) {
    fetch(`/diet/delete-saved-meal/${mealId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            mealCard.style.transition = 'opacity 0.5s ease';
            mealCard.style.opacity = '0';
            setTimeout(() => mealCard.remove(), 500);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An unexpected error occurred while deleting the meal.');
    });
}

function getRecommendedServings(mealId) {
    fetch(`/diet/get-recommended-servings/${mealId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            window.location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error getting recommended servings:', error);
        alert('Error getting recommended servings');
    });
}

function generateShoppingList() {
    window.location.href = "{% url 'diet:shopping_list' %}";
}

// ===== MEAL PLAN VERSIONING FUNCTIONS (ISOLATED) =====

// Global variables for versioning
let availableVersions = [];

// Create a new version of the current meal plan
async function createNewVersion() {
    try {
        const versionName = prompt('Enter a name for this version (optional):') || '';
        const notes = prompt('Add notes (optional):') || '';
        
        const response = await fetch('{% url "diet:create_meal_plan_version" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                version_name: versionName,
                notes: notes,
                action: 'manual'
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            alert(`Version "${data.data.version_name}" created successfully!`);
            updateVersionStatus(`Last saved: ${new Date().toLocaleString()}`);
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('Error creating version:', error);
        alert('Error creating version: ' + error.message);
    }
}

// Show the versions dropdown
async function showVersionsDropdown() {
    try {
        const response = await fetch('{% url "diet:get_meal_plan_versions" %}', {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            availableVersions = data.data;
            populateVersionsDropdown();
            document.getElementById('versions-dropdown-container').style.display = 'block';
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('Error fetching versions:', error);
        alert('Error fetching versions: ' + error.message);
    }
}

// Hide the versions dropdown
function hideVersionsDropdown() {
    document.getElementById('versions-dropdown-container').style.display = 'none';
}

// Populate the versions dropdown
function populateVersionsDropdown() {
    const dropdown = document.getElementById('versions-dropdown');
    dropdown.innerHTML = '<option value="">Select a version to restore...</option>';
    
    availableVersions.forEach(version => {
        const option = document.createElement('option');
        option.value = version.id;
        option.textContent = `${version.version_name} (${new Date(version.created_at).toLocaleString()}) - ${version.meal_count} meals`;
        dropdown.appendChild(option);
    });
}

// Restore the selected version
async function restoreSelectedVersion() {
    const dropdown = document.getElementById('versions-dropdown');
    const versionId = dropdown.value;
    
    if (!versionId) {
        alert('Please select a version to restore');
        return;
    }
    
    if (!confirm('This will replace your current meal plan with the selected version. Continue?')) {
        return;
    }
    
    try {
        const response = await fetch(`{% url "diet:restore_meal_plan_version" 0 %}`.replace('0', versionId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            alert(`Meal plan restored from "${data.data.version_name}"!`);
            hideVersionsDropdown();
            window.location.reload(); // Reload to show the restored plan
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('Error restoring version:', error);
        alert('Error restoring version: ' + error.message);
    }
}

// Update the version status display
function updateVersionStatus(message) {
    const statusElement = document.getElementById('version-status');
    statusElement.textContent = message;
}

// ===== CUSTOM MEAL MODAL FUNCTIONS =====

function openCustomMealModal() {
    document.getElementById('custom-meal-modal').style.display = 'block';
}

function closeCustomMealModal() {
    document.getElementById('custom-meal-modal').style.display = 'none';
    document.getElementById('custom-meal-form').reset(); // Clear the form
}

async function handleCustomMealSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    const mealData = {
        meal_name: formData.get('meal_name'),
        category: formData.get('category'),
        area: formData.get('area'),
        ingredients: formData.get('ingredients'),
        instructions: formData.get('instructions'),
    };

    // Store form data for the final save step
    sessionStorage.setItem('customMealData', JSON.stringify(mealData));

    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Analyzing Ingredients...';
    submitBtn.disabled = true;

    try {
        const response = await fetch('{% url "diet:add_custom_meal" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ ingredients: mealData.ingredients })
        });

        const result = await response.json();

        if (result.status === 'success') {
            displayIngredientChoices(result.ingredient_choices);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error getting ingredient choices:', error);
        alert('Error: ' + error.message);
        submitBtn.textContent = 'Save Custom Meal';
        submitBtn.disabled = false;
    }
}

function displayIngredientChoices(choices) {
    // Hide the original form and show the confirmation step
    document.getElementById('custom-meal-form-step1').style.display = 'none';
    const step2 = document.getElementById('custom-meal-form-step2');
    step2.style.display = 'block';

    const choicesContainer = document.getElementById('ingredient-choices-container');
    choicesContainer.innerHTML = ''; // Clear previous choices

    choices.forEach((choice, index) => {
        const choiceId = `choice-${index}`;
        const choiceHtml = `
            <div class="ingredient-choice">
                <input type="radio" name="ingredient_choice" id="${choiceId}" value="${index}" ${index === 0 ? 'checked' : ''}>
                <label for="${choiceId}">
                    <strong>Option ${index + 1}</strong>
                    <ul>
                        ${choice.map(ing => `<li>${ing.measure} ${ing.ingredient}</li>`).join('')}
                    </ul>
                </label>
            </div>
        `;
        choicesContainer.innerHTML += choiceHtml;
    });

    // Store choices for later retrieval
    sessionStorage.setItem('ingredientChoices', JSON.stringify(choices));
}

async function handleFinalSave() {
    const mealData = JSON.parse(sessionStorage.getItem('customMealData'));
    const allChoices = JSON.parse(sessionStorage.getItem('ingredientChoices'));
    const selectedChoiceIndex = document.querySelector('input[name="ingredient_choice"]:checked').value;
    
    const finalData = {
        ...mealData,
        chosen_ingredients: allChoices[selectedChoiceIndex]
    };

    const finalSaveBtn = document.getElementById('confirm-final-save');
    finalSaveBtn.textContent = 'Saving...';
    finalSaveBtn.disabled = true;

    try {
        const response = await fetch('{% url "diet:save_chosen_custom_meal" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(finalData)
        });

        const result = await response.json();

        if (result.status === 'success') {
            alert('Custom meal saved successfully! The AI will now calculate its nutritional info in the background.');
            closeCustomMealModal();
            window.location.reload();
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error saving final meal:', error);
        alert('Error: ' + error.message);
    } finally {
        finalSaveBtn.textContent = 'Confirm and Save';
        finalSaveBtn.disabled = false;
    }
}

function backToFormStep1() {
    document.getElementById('custom-meal-form-step1').style.display = 'block';
    document.getElementById('custom-meal-form-step2').style.display = 'none';
    document.getElementById('custom-meal-form').querySelector('button[type="submit"]').textContent = 'Save Custom Meal';
    document.getElementById('custom-meal-form').querySelector('button[type="submit"]').disabled = false;
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Custom Meal Modal Listeners
    document.getElementById('custom-meal-form').addEventListener('submit', handleCustomMealSubmit);
    document.querySelector('#custom-meal-modal .close-modal').addEventListener('click', closeCustomMealModal);
    document.getElementById('cancel-custom-meal').addEventListener('click', closeCustomMealModal);

    window.addEventListener('click', function(event) {
        const modal = document.getElementById('custom-meal-modal');
        if (event.target === modal) {
            closeCustomMealModal();
        }
    });

    document.getElementById('confirm-final-save').addEventListener('click', handleFinalSave);
    document.getElementById('back-to-form').addEventListener('click', backToFormStep1);
});

document.addEventListener('DOMContentLoaded', function() {
    // Render charts for each meal
    const chartContainers = document.querySelectorAll('.meal-charts-container');
    chartContainers.forEach(container => {
        const mealId = container.dataset.mealId;
        const caloriesPerServing = parseFloat(container.dataset.caloriesPerServing);
        const dailyTarget = parseFloat(container.dataset.dailyTarget);
        const protein = parseFloat(container.dataset.protein);
        const carbs = parseFloat(container.dataset.carbs);
        const fat = parseFloat(container.dataset.fat);

        // 1. Calorie Comparison Bar Chart
        const calorieCtx = document.getElementById(`calorie-chart-${mealId}`).getContext('2d');
        new Chart(calorieCtx, {
            type: 'bar',
            data: {
                labels: ['Daily Goal', 'This Meal (1 serving)'],
                datasets: [{
                    label: 'Calories (kcal)',
                    data: [dailyTarget, caloriesPerServing],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(255, 159, 64, 0.6)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Calorie Contribution'
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'kcal'
                        }
                    }
                }
            }
        });

        // 2. Macro Distribution Pie Chart
        const macroCtx = document.getElementById(`macro-chart-${mealId}`).getContext('2d');
        new Chart(macroCtx, {
            type: 'pie',
            data: {
                labels: ['Protein (g)', 'Carbs (g)', 'Fat (g)'],
                datasets: [{
                    label: 'Macronutrients',
                    data: [protein, carbs, fat],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.7)', // Blue
                        'rgba(255, 206, 86, 0.7)', // Yellow
                        'rgba(255, 99, 132, 0.7)'  // Red
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Macronutrient Grams'
                    },
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
    });
});

// --- Scrape daily target ---
let dailyTarget = 2000;
const targetElem = document.querySelector('.nutrition-analysis .highlight');
if (targetElem) {
    const match = targetElem.textContent.match(/([0-9]+)\s*calories/);
    if (match) dailyTarget = parseInt(match[1]);
}

// --- Scrape daily totals ---
const dayColumns = document.querySelectorAll('.week-overview .day-column');
const labels = [];
const calories = [];
const protein = [];
const carbs = [];
const fat = [];
dayColumns.forEach(col => {
    const header = col.querySelector('.day-header');
    if (!header) return;
    labels.push(header.textContent.trim());
    // Find daily totals section
    const totals = col.querySelector('.totals-grid');
    if (totals) {
        const cal = totals.querySelector('.total-item:nth-child(1) .total-value');
        const prot = totals.querySelector('.total-item:nth-child(2) .total-value');
        const carb = totals.querySelector('.total-item:nth-child(3) .total-value');
        const fatv = totals.querySelector('.total-item:nth-child(4) .total-value');
        calories.push(cal ? parseFloat(cal.textContent) : 0);
        protein.push(prot ? parseFloat(prot.textContent) : 0);
        carbs.push(carb ? parseFloat(carb.textContent) : 0);
        fat.push(fatv ? parseFloat(fatv.textContent) : 0);
    } else {
        calories.push(0); protein.push(0); carbs.push(0); fat.push(0);
    }
});

// --- Calorie Trend Line Chart ---
const calCtx = document.getElementById('calorie-trend-chart').getContext('2d');
new Chart(calCtx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [
            {
                label: 'Calories Consumed',
                data: calories,
                borderColor: '#36A2EB',
                backgroundColor: 'rgba(54,162,235,0.1)',
                tension: 0.3,
                pointRadius: 4,
                fill: true
            },
            {
                label: 'Daily Target',
                data: Array(labels.length).fill(dailyTarget),
                borderColor: '#FF6384',
                borderDash: [6, 6],
                pointRadius: 0,
                fill: false
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            title: { display: true, text: 'Calories vs. Target (7 Days)' },
            legend: { position: 'top' }
        },
        scales: {
            y: { beginAtZero: true, title: { display: true, text: 'kcal' } }
        }
    }
});

// --- Macro Stacked Bar Chart ---
const macroCtx = document.getElementById('macro-stacked-chart').getContext('2d');
new Chart(macroCtx, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [
            {
                label: 'Protein (g)',
                data: protein,
                backgroundColor: '#36A2EB'
            },
            {
                label: 'Carbs (g)',
                data: carbs,
                backgroundColor: '#FFCD56'
            },
            {
                label: 'Fat (g)',
                data: fat,
                backgroundColor: '#FF6384'
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            title: { display: true, text: 'Macronutrient Breakdown (7 Days)' },
            legend: { position: 'top' }
        },
        scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true, title: { display: true, text: 'grams' } }
        }
    }
});

// --- Progress Bars for Each Day ---
const barsContainer = document.getElementById('progress-bars-container');
barsContainer.innerHTML = '';
labels.forEach((label, i) => {
    const pct = Math.round((calories[i] / dailyTarget) * 100);
    const color = pct < 90 ? '#51cf66' : pct <= 110 ? '#ffd43b' : '#ff6b6b';
    const bar = document.createElement('div');
    bar.style.marginBottom = '12px';
    const barWidth = Math.min(100, pct); // Cap the bar width at 100%
    bar.innerHTML = `
        <div style="font-weight: 500; margin-bottom: 2px;">${label}</div>
        <div style="background: #dee2e6; border-radius: 6px; height: 22px; width: 100%; overflow: hidden; position: relative;">
            <div style="height: 100%; width: ${barWidth}%; background: ${color}; border-radius: 6px; transition: width 0.4s; position: absolute; left: 0; top: 0;"></div>
        </div>
        <div style="font-size: 0.95em; color: #495057; margin-top: 2px;">${calories[i]} kcal / ${dailyTarget} kcal (${pct}%)</div>
    `;
    barsContainer.appendChild(bar);
});
</script>

<!-- Move all debug dumps to the end of the page -->
<!-- <div style="background:#f9f9f9; border:1px solid #eee; padding:10px; margin-top:40px;">
    <h4>Debug: Daily Totals Calculation</h4>
    {% for day in week_days %}
        <div>
            <strong>{{ day.date|date:"D, M j" }}</strong>:
            {% with day_meals=planned_meals|get_item:day.formatted_date %}
                {{ day_meals|calculate_daily_totals }}
            {% endwith %}
        </div>
    {% endfor %}
</div> -->


<!-- Debug Data Dump -->
<!-- <div class="debug-data-dump">
    <h3>Debug Data</h3>
    <div class="data-section">
        <h4>Week Days Data:</h4>
        <pre>{{ week_days|pprint }}</pre>
    </div>
    <div class="data-section">
        <h4>Meal Slots:</h4>
        <pre>{{ meal_slots|pprint }}</pre>
    </div>
    <div class="data-section">
        <h4>Planned Meals:</h4>
        <pre>{{ planned_meals|pprint }}</pre>
    </div>
</div> -->

<!-- Progress Charts Playground (for requirements) -->
<div id="progress-charts-playground" style="margin-top: 48px; padding: 24px; background: #f8f9fa; border: 2px dashed #adb5bd; border-radius: 12px;">
    <h2 style="color: #495057; margin-bottom: 18px;">Nutrition Progress Charts</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 32px;">
        <div style="flex: 1; min-width: 320px;">
            <canvas id="calorie-trend-chart"></canvas>
        </div>
        <div style="flex: 1; min-width: 320px;">
            <canvas id="macro-stacked-chart"></canvas>
        </div>
    </div>
    <div id="progress-bars-container" style="margin-top: 32px;"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Scrape daily target ---
    let dailyTarget = 2000;
    const targetElem = document.querySelector('.nutrition-analysis .highlight');
    if (targetElem) {
        const match = targetElem.textContent.match(/([0-9]+)\s*calories/);
        if (match) dailyTarget = parseInt(match[1]);
    }

    // --- Scrape daily totals ---
    const dayColumns = document.querySelectorAll('.week-overview .day-column');
    const labels = [];
    const calories = [];
    const protein = [];
    const carbs = [];
    const fat = [];
    dayColumns.forEach(col => {
        const header = col.querySelector('.day-header');
        if (!header) return;
        labels.push(header.textContent.trim());
        // Find daily totals section
        const totals = col.querySelector('.totals-grid');
        if (totals) {
            const cal = totals.querySelector('.total-item:nth-child(1) .total-value');
            const prot = totals.querySelector('.total-item:nth-child(2) .total-value');
            const carb = totals.querySelector('.total-item:nth-child(3) .total-value');
            const fatv = totals.querySelector('.total-item:nth-child(4) .total-value');
            calories.push(cal ? parseFloat(cal.textContent) : 0);
            protein.push(prot ? parseFloat(prot.textContent) : 0);
            carbs.push(carb ? parseFloat(carb.textContent) : 0);
            fat.push(fatv ? parseFloat(fatv.textContent) : 0);
        } else {
            calories.push(0); protein.push(0); carbs.push(0); fat.push(0);
        }
    });

    // --- Calorie Trend Line Chart ---
    const calCtx = document.getElementById('calorie-trend-chart').getContext('2d');
    new Chart(calCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Calories Consumed',
                    data: calories,
                    borderColor: '#36A2EB',
                    backgroundColor: 'rgba(54,162,235,0.1)',
                    tension: 0.3,
                    pointRadius: 4,
                    fill: true
                },
                {
                    label: 'Daily Target',
                    data: Array(labels.length).fill(dailyTarget),
                    borderColor: '#FF6384',
                    borderDash: [6, 6],
                    pointRadius: 0,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'Calories vs. Target (7 Days)' },
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'kcal' } }
            }
        }
    });

    // --- Macro Stacked Bar Chart ---
    const macroCtx = document.getElementById('macro-stacked-chart').getContext('2d');
    new Chart(macroCtx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Protein (g)',
                    data: protein,
                    backgroundColor: '#36A2EB'
                },
                {
                    label: 'Carbs (g)',
                    data: carbs,
                    backgroundColor: '#FFCD56'
                },
                {
                    label: 'Fat (g)',
                    data: fat,
                    backgroundColor: '#FF6384'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'Macronutrient Breakdown (7 Days)' },
                legend: { position: 'top' }
            },
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true, title: { display: true, text: 'grams' } }
            }
        }
    });

    // --- Progress Bars for Each Day ---
    const barsContainer = document.getElementById('progress-bars-container');
    barsContainer.innerHTML = '';
    labels.forEach((label, i) => {
        const pct = Math.round((calories[i] / dailyTarget) * 100);
        const color = pct < 90 ? '#51cf66' : pct <= 110 ? '#ffd43b' : '#ff6b6b';
        const bar = document.createElement('div');
        bar.style.marginBottom = '12px';
        const barWidth = Math.min(100, pct); // Cap the bar width at 100%
        bar.innerHTML = `
            <div style="font-weight: 500; margin-bottom: 2px;">${label}</div>
            <div style="background: #dee2e6; border-radius: 6px; height: 22px; width: 100%; overflow: hidden; position: relative;">
                <div style="height: 100%; width: ${barWidth}%; background: ${color}; border-radius: 6px; transition: width 0.4s; position: absolute; left: 0; top: 0;"></div>
            </div>
            <div style="font-size: 0.95em; color: #495057; margin-top: 2px;">${calories[i]} kcal / ${dailyTarget} kcal (${pct}%)</div>
        `;
        barsContainer.appendChild(bar);
    });
});
</script>

<!-- AI Recipe Modal -->
<div id="ai-recipe-modal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:#fff; border:1px solid #ccc; border-radius:8px; padding:24px; z-index:1000; min-width:320px; width:80vw; max-width:80vw;">
    <button onclick="closeAiRecipeModal()" class="button" style="position:absolute; top:12px; right:18px; background:#e03131; color:#fff; border:none; border-radius:50%; width:32px; height:32px; font-size:1.2em; line-height:1;">&times;</button>
    <div id="ai-recipe-content" style="max-height:60vh; overflow-y:auto;"></div>
    <button onclick="closeAiRecipeModal()" class="button" style="margin-top:12px;">Close</button>
</div>
<div id="ai-recipe-backdrop" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.2); z-index:999;"></div>
<script>
function openAiRecipeModal() {
    document.getElementById('ai-recipe-modal').style.display = 'block';
    document.getElementById('ai-recipe-backdrop').style.display = 'block';
    document.getElementById('ai-recipe-content').innerHTML = '<div style="text-align:center; padding:40px;">Generating recipe...<br><br><span style="font-size:2em;">üç≥</span></div>';
    fetch('{% url 'diet:generate_ai_recipe' %}')
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                const recipe = data.recipe;
                let html = `<h2>${recipe.title}</h2>`;
                html += '<h4>Ingredients</h4><ul>';
                recipe.ingredients.forEach(ing => {
                    html += `<li>${ing.ingredient} - ${ing.measure}</li>`;
                });
                html += '</ul><h4>Instructions</h4><ol>';
                recipe.instructions.forEach(step => {
                    html += `<li>${step}</li>`;
                });
                html += '</ol>';
                html += '<button onclick="saveAiRecipeFromModal()" class="button primary" style="margin-top:18px;">Save This AI Recipe</button>';
                window._aiRecipeDraft = recipe;
                document.getElementById('ai-recipe-content').innerHTML = html;
            } else {
                document.getElementById('ai-recipe-content').innerHTML = '<div style="color:#e03131;">Error: ' + data.message + '</div>';
            }
        });
}
function closeAiRecipeModal() {
    document.getElementById('ai-recipe-modal').style.display = 'none';
    document.getElementById('ai-recipe-backdrop').style.display = 'none';
}
function prefillCustomMealFromAI() {
    if (!window._aiRecipeDraft) return;
    closeAiRecipeModal();
    // Prefill the custom meal modal with AI recipe data (simulate user input)
    openCustomMealModal();
    setTimeout(() => {
        document.getElementById('custom-meal-name').value = window._aiRecipeDraft.title || '';
        // Ingredients: try to fill textarea or fields
        let ingStr = '';
        if (window._aiRecipeDraft.ingredients && Array.isArray(window._aiRecipeDraft.ingredients)) {
            ingStr = window._aiRecipeDraft.ingredients.map(ing => `${ing.ingredient} - ${ing.measure}`).join('\n');
        }
        if (document.getElementById('custom-meal-ingredients')) {
            document.getElementById('custom-meal-ingredients').value = ingStr;
        }
        // Instructions
        let instrStr = '';
        if (window._aiRecipeDraft.instructions && Array.isArray(window._aiRecipeDraft.instructions)) {
            instrStr = window._aiRecipeDraft.instructions.join('\n');
        }
        if (document.getElementById('custom-meal-instructions')) {
            document.getElementById('custom-meal-instructions').value = instrStr;
        }
    }, 300);
}
function saveAiRecipeFromModal() {
    if (!window._aiRecipeDraft) return;
    fetch('{% url 'diet:save_ai_recipe' %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify(window._aiRecipeDraft)
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            closeAiRecipeModal();
            window.location.reload();
        } else {
            alert('Error saving recipe: ' + data.message);
        }
    });
}
</script>

<!-- Ingredient Substitute Modal -->
<div id="substitute-modal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width: 400px;">
    <div class="modal-header">
      <h2>Ingredient Substitute</h2>
      <span class="close-modal" id="close-sub-modal" style="cursor:pointer;">&times;</span>
    </div>
    <div class="modal-body">
      <div id="substitute-loading" style="display:none; color:#845ef7;">Finding substitute...</div>
      <div id="substitute-result" style="font-size:1.1em;"></div>
      <div style="margin-top:18px;">
        <label for="custom-sub-input" style="font-size:0.95em;">Or add your own:</label>
        <input type="text" id="custom-sub-input" style="width:100%; margin-top:4px; padding:6px; border-radius:4px; border:1px solid #ccc;">
      </div>
    </div>
    <div class="modal-footer" style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="button primary" id="use-ai-suggestion-btn">Use AI suggestion</button>
      <button class="button primary" id="use-custom-suggestion-btn" disabled>Use yours</button>
      <button class="button outline" id="close-sub-modal-btn">Close</button>
    </div>
  </div>
</div>
<script>
let lastSubIngredient = null;
let lastSubMealId = null;
let lastAiSuggestion = null;
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.substitute-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const ingredient = btn.getAttribute('data-ingredient');
      const mealId = btn.getAttribute('data-meal-id');
      lastSubIngredient = ingredient;
      lastSubMealId = mealId;
      document.getElementById('custom-sub-input').value = '';
      document.getElementById('use-custom-suggestion-btn').disabled = true;
      document.getElementById('substitute-result').textContent = '';
      document.getElementById('substitute-loading').style.display = 'block';
      document.getElementById('substitute-modal').style.display = 'block';
      fetch('/diet/suggest-ingredient-substitute/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ingredient: ingredient})
      })
      .then(r => r.json())
      .then(data => {
        document.getElementById('substitute-loading').style.display = 'none';
        if (data.status === 'success') {
          lastAiSuggestion = data.suggestion;
          document.getElementById('substitute-result').textContent = 'Suggested substitute: ' + data.suggestion;
        } else {
          lastAiSuggestion = null;
          document.getElementById('substitute-result').textContent = 'Error: ' + (data.message || 'No suggestion.');
        }
      })
      .catch(() => {
        lastAiSuggestion = null;
        document.getElementById('substitute-loading').style.display = 'none';
        document.getElementById('substitute-result').textContent = 'Error contacting server.';
      });
    });
  });
  document.getElementById('custom-sub-input').addEventListener('input', function() {
    document.getElementById('use-custom-suggestion-btn').disabled = !this.value.trim();
  });
  function closeSubModal() {
    document.getElementById('substitute-modal').style.display = 'none';
  }
  document.getElementById('close-sub-modal').onclick = closeSubModal;
  document.getElementById('close-sub-modal-btn').onclick = closeSubModal;
  window.onclick = function(event) {
    const modal = document.getElementById('substitute-modal');
    if (event.target === modal) modal.style.display = 'none';
  };
  function saveSubstitute(substitute) {
    if (!lastSubMealId || !lastSubIngredient || !substitute) return;
    fetch('/diet/save-meal-with-substitute/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        meal_id: lastSubMealId,
        original_ingredient: lastSubIngredient,
        substitute: substitute
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.status === 'success') {
        closeSubModal();
        window.location.reload();
      } else {
        alert('Error: ' + (data.message || 'Could not save.'));
      }
    })
    .catch(() => {
      alert('Error contacting server.');
    });
  }
  document.getElementById('use-ai-suggestion-btn').onclick = function() {
    if (lastAiSuggestion) saveSubstitute(lastAiSuggestion);
  };
  document.getElementById('use-custom-suggestion-btn').onclick = function() {
    const val = document.getElementById('custom-sub-input').value.trim();
    if (val) saveSubstitute(val);
  };
});
</script>

<!-- AI Nutritional Analysis JavaScript (Isolated) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-analysis-btn');
    const loadingDiv = document.getElementById('analysis-loading');
    const contentDiv = document.getElementById('analysis-content');
    const errorDiv = document.getElementById('analysis-error');
    const analysisText = document.getElementById('analysis-text');
    const errorMessage = document.getElementById('error-message');
    
    if (generateBtn) {
        generateBtn.addEventListener('click', function() {
            // Show loading state
            loadingDiv.style.display = 'block';
            contentDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            generateBtn.disabled = true;
            
            // Scrape data from the page (isolated approach)
            const scrapedData = scrapeNutritionData();
            
            // Call the AI analysis endpoint
            fetch('{% url "diet:generate_nutritional_analysis" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(scrapedData)
            })
            .then(response => response.json())
            .then(data => {
                loadingDiv.style.display = 'none';
                generateBtn.disabled = false;
                
                if (data.success) {
                    analysisText.textContent = data.analysis;
                    contentDiv.style.display = 'block';
                } else {
                    errorMessage.textContent = data.error || 'Failed to generate analysis';
                    errorDiv.style.display = 'block';
                }
            })
            .catch(error => {
                loadingDiv.style.display = 'none';
                generateBtn.disabled = false;
                errorMessage.textContent = 'Network error: ' + error.message;
                errorDiv.style.display = 'block';
            });
        });
    }
    
    function scrapeNutritionData() {
        const data = {
            daily_targets: {},
            daily_totals: {},
            wellness_score_info: {},
            daily_breakdown: []
        };
        
        // Scrape daily targets from nutrition plan section
        const targetElem = document.querySelector('.nutrition-analysis .highlight');
        if (targetElem) {
            const match = targetElem.textContent.match(/([0-9]+)\s*calories/);
            if (match) {
                data.daily_targets.calories = parseInt(match[1]);
            }
        }
        
        // Scrape macro split from nutrition plan
        const macroElements = document.querySelectorAll('.nutrition-analysis .macro-value');
        if (macroElements.length >= 3) {
            data.daily_targets.protein = parseInt(macroElements[0].textContent);
            data.daily_targets.carbs = parseInt(macroElements[1].textContent);
            data.daily_targets.fat = parseInt(macroElements[2].textContent);
        }
        
        // Scrape wellness score info
        const wellnessSection = document.querySelector('.wellness-score-summary');
        if (wellnessSection) {
            const baseScoreMatch = wellnessSection.textContent.match(/Base:\s*([0-9]+)/);
            const adjustedScoreMatch = wellnessSection.textContent.match(/([0-9]+)\s*\(Base:/);
            const adherenceMatch = wellnessSection.textContent.match(/Adherence Ratio:\s*([0-9.]+)/);
            
            if (baseScoreMatch) data.wellness_score_info.base_score = parseInt(baseScoreMatch[1]);
            if (adjustedScoreMatch) data.wellness_score_info.adjusted_score = parseInt(adjustedScoreMatch[1]);
            if (adherenceMatch) data.wellness_score_info.adherence_ratio = parseFloat(adherenceMatch[1]);
        }
        
        // Scrape daily totals from the 7-day plan
        const dayColumns = document.querySelectorAll('.week-overview .day-column');
        let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0;
        
        dayColumns.forEach((col, index) => {
            const header = col.querySelector('.day-header');
            const totals = col.querySelector('.totals-grid');
            
            if (header && totals) {
                const dayName = header.textContent.trim();
                const calElem = totals.querySelector('.total-item:nth-child(1) .total-value');
                const protElem = totals.querySelector('.total-item:nth-child(2) .total-value');
                const carbElem = totals.querySelector('.total-item:nth-child(3) .total-value');
                const fatElem = totals.querySelector('.total-item:nth-child(4) .total-value');
                
                const dayCalories = calElem ? parseFloat(calElem.textContent) : 0;
                const dayProtein = protElem ? parseFloat(protElem.textContent) : 0;
                const dayCarbs = carbElem ? parseFloat(carbElem.textContent) : 0;
                const dayFat = fatElem ? parseFloat(fatElem.textContent) : 0;
                
                // Add to totals
                totalCalories += dayCalories;
                totalProtein += dayProtein;
                totalCarbs += dayCarbs;
                totalFat += dayFat;
                
                // Add to daily breakdown
                data.daily_breakdown.push({
                    day: dayName,
                    calories: dayCalories,
                    protein: dayProtein,
                    carbs: dayCarbs,
                    fat: dayFat
                });
            }
        });
        
        // Set weekly totals
        data.daily_totals.total_calories = totalCalories;
        data.daily_totals.total_protein = totalProtein;
        data.daily_totals.total_carbs = totalCarbs;
        data.daily_totals.total_fat = totalFat;
        
        return data;
    }
});
</script>
