{% load static %}
{% load diet_extras %}

<div class="specific-meals">
    <div class="navigation-buttons">
        <a href="{% url 'users:dashboard' %}" class="button outline">‚Üê Back to Dashboard</a>
        <a href="{% url 'diet:my_saved_meals' %}" class="button outline">üìã My Saved Meals</a>
    </div>

    <h1>Meal Planning & Management</h1>

    {% if meal_analysis %}
    <div class="nutrition-analysis">
        <h2>Your Nutrition Plan</h2>
        <div class="analysis-grid">
            <div class="analysis-section">
                <h3>Daily Targets</h3>
                <p class="highlight">{{ meal_analysis.daily_calories }} calories per day</p>
                
                <h4>Macro Split</h4>
                <div class="macro-distribution">
                    <div class="macro">
                        <span class="macro-label">Protein</span>
                        <span class="macro-value">{{ meal_analysis.macro_split.protein }}%</span>
                    </div>
                    <div class="macro">
                        <span class="macro-label">Carbs</span>
                        <span class="macro-value">{{ meal_analysis.macro_split.carbs }}%</span>
                    </div>
                    <div class="macro">
                        <span class="macro-label">Fats</span>
                        <span class="macro-value">{{ meal_analysis.macro_split.fats }}%</span>
                    </div>
                </div>
            </div>

            {% if meal_baseline %}
            <div class="analysis-section wide">
                <h3>Suggested Meals</h3>
                <div class="meal-suggestions">
                    {% for meal_time, components in meal_baseline.meal_templates.items %}
                    <div class="meal-suggestion-card">
                        <h4>{{ meal_time|title }}</h4>
                        <div class="suggested-items">
                            {% for component in components %}
                            <div class="suggestion-item">
                                <span>{{ component }}</span>
                                <button class="search-btn" onclick="searchFood('{{ component }}')">
                                    Search USDA
                                    <span class="icon">üîç</span>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="meal-calories">
                            Target: {{ meal_analysis.daily_calories|multiply:meal_analysis.meal_size_distribution|get_item:meal_time|divide:100|floatformat:0 }} calories
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="search-sections">
        <!-- USDA Food Search -->
        <div class="food-search-section search-box">
            <h2>USDA Food Search</h2>
            <div class="search-container">
                <input type="text" id="food-search" placeholder="Search USDA foods..." class="search-input">
                <button onclick="searchFood()" class="search-button">Search</button>
            </div>
            <div id="search-results" class="search-results"></div>
        </div>

        <!-- Recipe Search mealdb api-->
        <div class="recipe-search-section search-box">
            <h2>Recipe Search</h2>
            <div class="search-container">
                <input type="text" id="recipe-search" placeholder="Search for recipes..." class="search-input">
                <button onclick="searchRecipes()" class="search-button">Search Recipes</button>
            </div>
            <div id="recipe-results" class="search-results"></div>
        </div>
    </div>
</div>

<style>
.specific-meals {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.navigation-buttons {
    margin-bottom: 20px;
    padding: 10px 0;
}

.button.outline {
    background: transparent;
    border: 2px solid #6c757d;
    color: #6c757d;
    text-decoration: none;
    padding: 8px 16px;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.button.outline:hover {
    background: #6c757d;
    color: white;
}

.nutrition-analysis {
    background: white;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin: 30px 0;
}

.analysis-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.analysis-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 5px;
}

.analysis-section.wide {
    grid-column: 1 / -1;
}

.highlight {
    font-size: 1.5em;
    color: #007bff;
    font-weight: 500;
    margin: 10px 0;
}

.macro-distribution {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 15px;
}

.macro {
    text-align: center;
    padding: 10px;
    background: white;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.macro-label {
    display: block;
    color: #6c757d;
    font-size: 0.9em;
}

.macro-value {
    display: block;
    font-size: 1.2em;
    font-weight: 500;
    color: #212529;
}

.meal-suggestions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.meal-suggestion-card {
    background: white;
    padding: 15px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.meal-suggestion-card h4 {
    margin: 0 0 15px 0;
    color: #343a40;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 8px;
}

.suggested-items {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.suggestion-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 4px;
    font-size: 0.95em;
}

.search-btn {
    background: transparent;
    border: 1px solid #6c757d;
    color: #6c757d;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.2s ease;
}

.search-btn:hover {
    background: #6c757d;
    color: white;
}

.search-btn .icon {
    font-size: 0.9em;
}

.meal-calories {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #dee2e6;
    color: #6c757d;
    font-size: 0.9em;
    text-align: right;
}

.search-sections {
    display: grid;
    grid-template-columns: 1fr;
    gap: 30px;
    margin-top: 30px;
}

.search-box {
    background: white;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.search-container {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.search-input {
    flex: 1;
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-size: 1em;
}

.search-button {
    padding: 10px 20px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s ease;
}

.search-button:hover {
    background: #0056b3;
}

.search-results {
    min-height: 200px;
}

.food-card {
    background: white;
    padding: 15px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    margin-bottom: 15px;
}

.food-item {
    cursor: pointer;
    transition: transform 0.2s;
}

.food-item:hover {
    transform: translateY(-2px);
}

.food-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.nutrient {
    background: #f8f9fa;
    padding: 8px;
    border-radius: 4px;
    text-align: center;
}

.nutrient-label {
    color: #6c757d;
    font-size: 0.9em;
}

.nutrient-value {
    font-weight: 500;
    color: #212529;
}

.click-hint {
    color: #6c757d;
    font-size: 0.9em;
    margin-top: 10px;
    text-align: center;
}

.food-details-expanded {
    background: white;
    padding: 20px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.nutrient-category {
    margin: 20px 0;
}

.nutrient-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.back-button {
    margin-top: 20px;
    padding: 8px 16px;
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
}

.back-button:hover {
    background: #5a6268;
}

.loading {
    text-align: center;
    color: #6c757d;
    padding: 20px;
}

.error {
    color: #dc3545;
    background: #f8d7da;
    padding: 15px;
    border-radius: 4px;
    margin: 10px 0;
}

.no-results {
    text-align: center;
    color: #6c757d;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 4px;
}

.recipe-card {
    background: white;
    padding: 15px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    margin-bottom: 15px;
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 15px;
}

.recipe-details {
    grid-column: 1 / -1;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #dee2e6;
    display: none;  /* Hidden by default */
}

.recipe-details.active {
    display: block;
}

.recipe-details h4 {
    margin: 15px 0 10px;
    color: #2c3e50;
}

.ingredients-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
}

.ingredient-item {
    display: flex;
    justify-content: space-between;
    padding: 5px;
    background: #f8f9fa;
    border-radius: 4px;
}

.instructions-list {
    list-style-position: inside;
    padding-left: 0;
}

.instructions-list li {
    margin-bottom: 10px;
    line-height: 1.5;
}

.recipe-links {
    margin-top: 15px;
    display: flex;
    gap: 10px;
}

.recipe-link {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.9em;
    color: #fff;
}

.youtube-link {
    background: #ff0000;
}

.source-link {
    background: #6c757d;
}

.recipe-image {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 4px;
}

.recipe-content {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.recipe-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
}

.recipe-title {
    margin: 0;
    font-size: 1.2em;
    color: #2c3e50;
}

.recipe-meta {
    color: #6c757d;
    font-size: 0.9em;
}

.recipe-ingredients {
    font-size: 0.9em;
    color: #495057;
}

.recipe-actions {
    display: flex;
    gap: 10px;
    margin-top: auto;
}

.recipe-button {
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    transition: background 0.2s ease;
}

.view-recipe {
    background: #007bff;
    color: white;
}

.view-recipe:hover {
    background: #0056b3;
}

.save-recipe {
    background: #28a745;
    color: white;
}

.save-recipe:hover {
    background: #218838;
}
</style>

<script>
function searchFood(suggestion = null) {
    const searchInput = document.getElementById('food-search');
    if (suggestion) {
        searchInput.value = suggestion;
    }
    const query = searchInput.value.trim();
    if (!query) return;

    // Show loading state
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = '<div class="loading">Searching...</div>';

    // Call your USDA search endpoint - using the existing endpoint
    fetch(`/diet/search-food/?query=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            resultsDiv.innerHTML = ''; // Clear loading state
            if (data.status === 'success' && data.foods && data.foods.length > 0) {
                data.foods.forEach(food => {
                    const foodCard = document.createElement('div');
                    foodCard.className = 'food-card';
                    
                    // Render food information with the existing data structure
                    foodCard.innerHTML = `
                        <div class="food-item" onclick="getFoodDetails(${food.fdcId})">
                            <h3>${food.description}</h3>
                            <p>${food.brandOwner !== 'Generic' ? food.brandOwner : ''}</p>
                            ${food.servingSize ? `<p>Serving: ${food.servingSize} ${food.servingSizeUnit || ''}</p>` : ''}
                            <div class="food-details">
                                ${food.nutrients.calories ? `
                                    <div class="nutrient">
                                        <div class="nutrient-label">Calories</div>
                                        <div class="nutrient-value">${food.nutrients.calories.amount} ${food.nutrients.calories.unit}</div>
                                    </div>
                                ` : ''}
                                ${food.nutrients.protein ? `
                                    <div class="nutrient">
                                        <div class="nutrient-label">Protein</div>
                                        <div class="nutrient-value">${food.nutrients.protein.amount} ${food.nutrients.protein.unit}</div>
                                    </div>
                                ` : ''}
                                ${food.nutrients.carbs ? `
                                    <div class="nutrient">
                                        <div class="nutrient-label">Carbs</div>
                                        <div class="nutrient-value">${food.nutrients.carbs.amount} ${food.nutrients.carbs.unit}</div>
                                    </div>
                                ` : ''}
                                ${food.nutrients.fat ? `
                                    <div class="nutrient">
                                        <div class="nutrient-label">Fat</div>
                                        <div class="nutrient-value">${food.nutrients.fat.amount} ${food.nutrients.fat.unit}</div>
                                    </div>
                                ` : ''}
                            </div>
                            <p class="click-hint">Click for detailed information</p>
                        </div>
                    `;
                    resultsDiv.appendChild(foodCard);
                });
            } else {
                resultsDiv.innerHTML = '<div class="no-results">No foods found</div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resultsDiv.innerHTML = '<div class="error">Error searching for foods</div>';
        });
}

function getFoodDetails(fdcId) {
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = '<div class="loading">Loading details...</div>';

    fetch(`/diet/search-food/?fdcId=${fdcId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const food = data.food;
                let html = `
                    <div class="food-details-expanded">
                        <h2>${food.description}</h2>
                        <p>${food.brandOwner !== 'Generic' ? food.brandOwner : ''}</p>
                        ${food.servingSize ? `<p>Serving: ${food.servingSize} ${food.servingSizeUnit || ''}</p>` : ''}
                `;

                if (food.ingredients) {
                    html += `
                        <div class="ingredients-section">
                            <h3>Ingredients</h3>
                            <p>${food.ingredients}</p>
                        </div>
                    `;
                }

                // Display nutrients by category
                for (const [category, nutrients] of Object.entries(food.nutrients)) {
                    html += `
                        <div class="nutrient-category">
                            <h3>${category.charAt(0).toUpperCase() + category.slice(1)}</h3>
                            <div class="nutrient-grid">
                                ${nutrients.map(n => `
                                    <div class="nutrient">
                                        <div class="nutrient-label">${n.name}</div>
                                        <div class="nutrient-value">${n.amount} ${n.unit}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                html += `
                    <button onclick="searchFood()" class="back-button">‚Üê Back to Search Results</button>
                </div>`;
                
                resultsDiv.innerHTML = html;
            } else {
                resultsDiv.innerHTML = `<div class="error">${data.message || 'Error loading details'}</div>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resultsDiv.innerHTML = '<div class="error">Error loading food details</div>';
        });
}

// Add event listener for Enter key in search input
document.getElementById('food-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchFood();
    }
});

function searchRecipes() {
    const query = document.getElementById('recipe-search').value.trim();
    const resultsDiv = document.getElementById('recipe-results');
    
    if (!query) {
        resultsDiv.innerHTML = '<p>Please enter a search term</p>';
        return;
    }
    
    resultsDiv.innerHTML = '<p>Searching...</p>';
    
    fetch(`/diet/search-recipe/?query=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            resultsDiv.innerHTML = '';
            if (data.status === 'success' && data.recipes && data.recipes.length > 0) {
                data.recipes.forEach(recipe => {
                    const recipeCard = document.createElement('div');
                    recipeCard.className = 'recipe-card';
                    recipeCard.id = `recipe-${recipe.id}`;
                    
                    // Format ingredients list
                    const ingredientsList = recipe.ingredients
                        .map(ing => `${ing.measure} ${ing.ingredient}`)
                        .slice(0, 3)
                        .join(', ') + (recipe.ingredients.length > 3 ? '...' : '');
                    
                    recipeCard.innerHTML = `
                        <img src="${recipe.image}" alt="${recipe.name}" class="recipe-image">
                        <div class="recipe-content">
                            <div class="recipe-header">
                                <h3 class="recipe-title">${recipe.name}</h3>
                                <span class="recipe-meta">${recipe.category} ‚Ä¢ ${recipe.area}</span>
                            </div>
                            <div class="recipe-ingredients">
                                <strong>Key ingredients:</strong> ${ingredientsList}
                            </div>
                            <div class="recipe-actions">
                                <button class="recipe-button view-recipe" onclick="viewRecipeDetails('${recipe.id}', this)">
                                    View Recipe
                                </button>
                                <button class="recipe-button save-recipe" onclick="saveRecipe('${recipe.id}')">
                                    Save Recipe
                                </button>
                            </div>
                        </div>
                        <div class="recipe-details" id="details-${recipe.id}"></div>
                    `;
                    
                    resultsDiv.appendChild(recipeCard);
                });
            } else {
                resultsDiv.innerHTML = '<p>No recipes found</p>';
            }
        })
        .catch(error => {
            resultsDiv.innerHTML = `<p>Error searching recipes: ${error.message}</p>`;
        });
}

function viewRecipeDetails(recipeId, button) {
    const detailsDiv = document.getElementById(`details-${recipeId}`);
    
    // If details are already loaded and visible, just toggle visibility
    if (detailsDiv.classList.contains('active')) {
        detailsDiv.classList.remove('active');
        button.textContent = 'View Recipe';
        return;
    }
    
    // Show loading state
    detailsDiv.innerHTML = '<p>Loading recipe details...</p>';
    detailsDiv.classList.add('active');
    button.textContent = 'Hide Recipe';
    
    fetch(`/diet/recipe-details/?id=${recipeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const recipe = data.recipe;
                
                // Create ingredients list HTML
                const ingredientsHtml = `
                    <h4>Ingredients</h4>
                    <div class="ingredients-list">
                        ${recipe.ingredients.map(ing => `
                            <div class="ingredient-item">
                                <span>${ing.ingredient}</span>
                                <span>${ing.measure}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                // Create instructions list HTML
                const instructionsHtml = `
                    <h4>Instructions</h4>
                    <ol class="instructions-list">
                        ${recipe.instructions.map(step => `
                            <li>${step}</li>
                        `).join('')}
                    </ol>
                `;
                
                // Create links HTML
                const linksHtml = `
                    <div class="recipe-links">
                        ${recipe.youtube ? `
                            <a href="${recipe.youtube}" target="_blank" class="recipe-link youtube-link">
                                Watch on YouTube
                            </a>
                        ` : ''}
                        ${recipe.source ? `
                            <a href="${recipe.source}" target="_blank" class="recipe-link source-link">
                                View Source
                            </a>
                        ` : ''}
                    </div>
                `;
                
                detailsDiv.innerHTML = `
                    ${ingredientsHtml}
                    ${instructionsHtml}
                    ${linksHtml}
                `;
            } else {
                detailsDiv.innerHTML = `<p>Error: ${data.message}</p>`;
                detailsDiv.classList.remove('active');
                button.textContent = 'View Recipe';
            }
        })
        .catch(error => {
            detailsDiv.innerHTML = `<p>Error loading recipe details: ${error.message}</p>`;
            detailsDiv.classList.remove('active');
            button.textContent = 'View Recipe';
        });
}

function saveRecipe(recipeId) {
    const button = document.querySelector(`#recipe-${recipeId} .save-recipe`);
    const originalText = button.textContent;
    
    // Show saving state
    button.textContent = 'Saving...';
    button.disabled = true;
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='))?.split('=')[1];
    
    const formData = new FormData();
    formData.append('meal_id', recipeId);
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken);
    }
    
    fetch('/diet/save-meal/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken || '',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            button.textContent = '‚úì Saved';
            button.style.background = '#6c757d';
            showNotification(data.message, 'success');
        } else if (data.status === 'info') {
            button.textContent = '‚úì Already Saved';
            button.style.background = '#6c757d';
            showNotification(data.message, 'info');
        } else {
            button.textContent = originalText;
            showNotification(data.message || 'Error saving recipe', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        button.textContent = originalText;
        showNotification('Network error saving recipe', 'error');
    })
    .finally(() => {
        button.disabled = false;
    });
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    // Style notification
    Object.assign(notification.style, {
        position: 'fixed',
        top: '20px',
        right: '20px',
        padding: '12px 20px',
        borderRadius: '4px',
        color: 'white',
        zIndex: '1000',
        fontSize: '14px',
        maxWidth: '300px',
        wordWrap: 'break-word'
    });
    
    // Set background color based on type
    const colors = {
        success: '#28a745',
        error: '#dc3545',
        info: '#17a2b8'
    };
    notification.style.background = colors[type] || colors.info;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}
</script> 