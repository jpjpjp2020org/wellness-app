{% load static %}
{% load diet_extras %}

<div class="shopping-list-container">
    <div class="shopping-list-actions" style="margin-bottom: 18px;">
        <a href="{% url 'diet:adjust_shopping_list' %}" class="button" style="background: #51cf66; color: #fff; font-size: 1.15em; padding: 12px 28px; border-radius: 6px; border: none; box-shadow: 0 2px 6px rgba(81,207,102,0.08);">Adjust and Finalize Shopping List</a>
    </div>

    <div class="navigation-buttons">
        <a href="{% url 'diet:my_saved_meals' %}" class="button outline">‚Üê Back to Saved Meals</a>
    </div>

    <h1>Shopping List</h1>
    <p class="date-range">For {{ start_date|date:"M d" }} - {{ end_date|date:"M d, Y" }}</p>

    <!-- Per-Meal Section -->
    <div class="meal-based-list">
        <h2>Meals in Your Plan</h2>
        {% for meal_name, count in meal_counts.items %}
        <div class="meal-section">
            <div class="meal-header">
                <h3>{{ meal_name }}</h3>
                <span class="meal-count">In plan: {{ count }} time{{ count|pluralize }}</span>
            </div>
            
            <div class="ingredients-list">
                {% for ingredient in meal_ingredients|get_item:meal_name %}
                <div class="ingredient-item">
                    <span class="ingredient-name">{{ ingredient.ingredient }}</span>
                    <span class="ingredient-measure">{{ ingredient.measure }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Aggregated Shopping List -->
    <div class="aggregated-list">
        <h2>Combined Shopping List</h2>
        {% for category, ingredients in categorized_ingredients.items %}
        <div class="category-section">
            <h3>{{ category|title }}</h3>
            <div class="ingredients-grid">
                {% for ing in ingredients %}
                <div class="ingredient-card">
                    <div class="ingredient-header">
                        <h4>{{ ing.name|title }}</h4>
                        <span class="amount">{{ ing.amount }} {{ ing.unit }}</span>
                    </div>
                    <div class="ingredient-details">
                        {% if ing.original_names|length > 1 %}
                        <p class="variations">Also listed as: {{ ing.original_names|join:", " }}</p>
                        {% endif %}
                        <p class="meals">Used in: {{ ing.meals|join:", " }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Debug Section -->
    <div class="debug-section">
        <h3>Debug Data</h3>
        <div class="debug-item">
            <h4>Aggregated Ingredients:</h4>
            <pre>{{ debug_data.aggregated_ingredients|pprint }}</pre>
        </div>
        <div class="debug-item">
            <h4>Meal Counts:</h4>
            <pre>{{ debug_data.meal_counts|pprint }}</pre>
        </div>
        <div class="debug-item">
            <h4>Meal Ingredients:</h4>
            <pre>{{ debug_data.meal_ingredients|pprint }}</pre>
        </div>
    </div>
</div>

<style>
.shopping-list-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.date-range {
    color: #666;
    margin-bottom: 30px;
}

.meal-section {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 20px;
    padding: 15px;
}

.meal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.meal-count {
    background: #e9ecef;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9em;
    color: #666;
}

.ingredients-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 10px;
}

.ingredient-item {
    display: flex;
    justify-content: space-between;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 4px;
}

.ingredient-name {
    font-weight: 500;
}

.ingredient-measure {
    color: #666;
}

/* Aggregated List Styles */
.aggregated-list {
    margin-top: 40px;
}

.category-section {
    margin-bottom: 30px;
}

.category-section h3 {
    color: #2c3e50;
    margin-bottom: 15px;
    padding-bottom: 5px;
    border-bottom: 2px solid #eee;
}

.ingredients-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
}

.ingredient-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
}

.ingredient-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.ingredient-header h4 {
    margin: 0;
    color: #2c3e50;
}

.amount {
    background: #e9ecef;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9em;
}

.ingredient-details {
    font-size: 0.9em;
    color: #666;
}

.variations {
    margin-bottom: 5px;
    font-style: italic;
}

.meals {
    margin: 0;
}

/* Debug Section */
.debug-section {
    margin-top: 40px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.debug-item {
    margin-bottom: 20px;
}

.debug-item pre {
    background: white;
    padding: 10px;
    border-radius: 4px;
    overflow-x: auto;
}
</style> 