{% load static %}
{% load dashboard_utils %}

<div class="dashboard-insights" style="margin-top: 32px;">
    <h2>Integrated Health & Nutrition Insights</h2>
    
    <!-- Health Profile & Insights -->
    <div style="margin-bottom: 24px;">
        <h3>Health Profile & Insights</h3>
        <div class="health-charts-container" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; min-height: 400px;">
            
            {% if health_data.error %}
                <div style="color: #721c24; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 10px;">
                    <strong>Error:</strong> {{ health_data.error }}
                </div>
            {% else %}
                <!-- Health Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    {% if health_data.profile %}
                        <div style="background: #e3f2fd; border-radius: 8px; padding: 16px; text-align: center;">
                            <h4 style="margin: 0 0 8px 0; color: #1976d2;">BMI</h4>
                            <div style="font-size: 1.5em; font-weight: bold; color: #1976d2;">{{ health_data.profile.bmi|floatformat:1 }}</div>
                        </div>
                        
                        <div style="background: #e8f5e8; border-radius: 8px; padding: 16px; text-align: center;">
                            <h4 style="margin: 0 0 8px 0; color: #2e7d32;">Weight</h4>
                            <div style="font-size: 1.5em; font-weight: bold; color: #2e7d32;">{{ health_data.profile.weight_kg|floatformat:1 }} kg</div>
                        </div>
                        
                        <div style="background: #fff3e0; border-radius: 8px; padding: 16px; text-align: center;">
                            <h4 style="margin: 0 0 8px 0; color: #f57c00;">Wellness Score</h4>
                            <div style="font-size: 1.5em; font-weight: bold; color: #f57c00;">{{ health_data.profile.wellness_score|default:"N/A" }}</div>
                        </div>
                        
                        {% if health_data.goals.target_weight %}
                        <div style="background: #f3e5f5; border-radius: 8px; padding: 16px; text-align: center;">
                            <h4 style="margin: 0 0 8px 0; color: #7b1fa2;">Target Weight</h4>
                            <div style="font-size: 1.5em; font-weight: bold; color: #7b1fa2;">{{ health_data.goals.target_weight|floatformat:1 }} kg</div>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>

                <!-- Health Charts Section (fixed height, grid) -->
                <div class="charts-section" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="chart-container" style="background: white; padding: 20px; padding-bottom: 48px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: 300px;">
                        <h4 style="margin-bottom: 12px;">Weight Trend</h4>
                        <canvas id="weightChart" style="height: 220px !important;"></canvas>
                    </div>
                    <div class="chart-container" style="background: white; padding: 20px; padding-bottom: 48px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: 300px;">
                        <h4 style="margin-bottom: 12px;">Wellness Score Trend</h4>
                        <canvas id="wellnessChart" style="height: 220px !important;"></canvas>
                    </div>
                </div>

                <!-- Goal Progress -->
                {% if health_data.trends.goal_progress %}
                <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; margin-top: 16px;">
                    <h4 style="margin: 0 0 12px 0;">Goal Progress</h4>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="flex: 1;">
                            <div style="background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">
                                <div style="background: #28a745; height: 100%; width: {{ health_data.trends.goal_progress.progress_percentage }}%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                        <div style="font-weight: bold; color: #495057;">
                            {{ health_data.trends.goal_progress.progress_percentage|floatformat:1 }}%
                        </div>
                    </div>
                    <div style="font-size: 0.9em; color: #6c757d; margin-top: 8px;">
                        {{ health_data.trends.goal_progress.remaining_weight|floatformat:1 }} kg to go
                    </div>
                </div>
                {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- Nutrition Plan & AI Analysis -->
    <div>
        <h3>Nutrition Plan & AI Analysis</h3>
        <div class="nutrition-charts-container" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; min-height: 500px;">
            
            {% if diet_data.error %}
                <div style="color: #721c24; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 10px;">
                    <strong>Error:</strong> {{ diet_data.error }}
                </div>
            {% else %}
                <!-- Nutrition Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    {% if diet_data.nutrition_adherence %}
                        <div style="background: #e8f5e8; border-radius: 8px; padding: 16px; text-align: center;">
                            <h4 style="margin: 0 0 8px 0; color: #2e7d32;">Weekly Calories</h4>
                            <div style="font-size: 1.3em; font-weight: bold; color: #2e7d32;">{{ diet_data.nutrition_adherence.current_week_calories|floatformat:0 }}</div>
                            <div style="font-size: 0.8em; color: #6c757d;">Target: {{ diet_data.nutrition_adherence.weekly_target_calories|floatformat:0 }}</div>
                        </div>
                        
                        <div style="background: #e3f2fd; border-radius: 8px; padding: 16px; text-align: center;">
                            <h4 style="margin: 0 0 8px 0; color: #1976d2;">Days with Meals</h4>
                            <div style="font-size: 1.3em; font-weight: bold; color: #1976d2;">{{ diet_data.nutrition_adherence.days_with_meals }}/7</div>
                        </div>
                        
                        <div style="background: #fff3e0; border-radius: 8px; padding: 16px; text-align: center;">
                            <h4 style="margin: 0 0 8px 0; color: #f57c00;">Saved Meals</h4>
                            <div style="font-size: 1.3em; font-weight: bold; color: #f57c00;">{{ diet_data.saved_meals.count }}</div>
                        </div>
                        
                        {% if diet_data.nutrition_adherence.adjusted_wellness_score %}
                        <div style="background: #f3e5f5; border-radius: 8px; padding: 16px; text-align: center;">
                            <h4 style="margin: 0 0 8px 0; color: #7b1fa2;">Nutrition Score</h4>
                            <div style="font-size: 1.3em; font-weight: bold; color: #7b1fa2;">{{ diet_data.nutrition_adherence.adjusted_wellness_score }}</div>
                            <div style="font-size: 0.8em; color: #6c757d;">Base: {{ diet_data.nutrition_adherence.base_wellness_score }}</div>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>

                <!-- Nutrition Charts Section (fixed height, grid) -->
                <div class="charts-section" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: 300px;">
                        <h4 style="margin-bottom: 12px;">Weekly Calorie Intake</h4>
                        <canvas id="calorieChart" style="height: 220px !important;"></canvas>
                    </div>
                    <div class="chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: 300px;">
                        <h4 style="margin-bottom: 12px;">Daily Macronutrient Breakdown</h4>
                        <canvas id="dailyMacrosChart" style="height: 220px !important;"></canvas>
                    </div>
                    <!-- <div class="chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: 300px;">
                        <h4 style="margin-bottom: 12px;">Macro Distribution</h4>
                        <canvas id="macroChart" style="height: 220px !important;"></canvas>
                    </div> -->
                </div>

                <!-- Daily Meal Plan Summary -->
                {% if diet_data.current_plan.daily_totals %}
                <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; margin-top: 16px;">
                    <h4 style="margin: 0 0 12px 0;">This Week's Meal Plan</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                        {% for date_key, day_data in diet_data.current_plan.daily_totals.items %}
                        <div style="background: white; border-radius: 6px; padding: 12px; text-align: center; border: 1px solid #dee2e6;">
                            <div style="font-weight: bold; font-size: 0.9em; color: #495057; margin-bottom: 4px;">
                                {{ date_key|slice:"5:" }}
                            </div>
                            <div style="font-size: 1.1em; font-weight: bold; color: #28a745;">
                                {{ day_data.calories|floatformat:0 }} cal
                            </div>
                            <div style="font-size: 0.8em; color: #6c757d;">
                                {{ day_data.meals|length }} meals
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Health Charts
{% if health_data.history.weight_history %}
const weightCtx = document.getElementById('weightChart').getContext('2d');
const weightChart = new Chart(weightCtx, {
    type: 'line',
    data: {
        labels: [{% for entry in health_data.history.weight_history %}'{{ entry.date|date_ymd }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Weight (kg)',
            data: [{% for entry in health_data.history.weight_history %}{{ entry.weight }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            borderColor: '#1976d2',
            backgroundColor: 'rgba(25, 118, 210, 0.1)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: false
            }
        }
    }
});
{% endif %}

{% if health_data.history.score_history %}
const wellnessCtx = document.getElementById('wellnessChart').getContext('2d');
const wellnessChart = new Chart(wellnessCtx, {
    type: 'line',
    data: {
        labels: [{% for entry in health_data.history.score_history %}'{{ entry.date|date_ymd }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Wellness Score',
            data: [{% for entry in health_data.history.score_history %}{{ entry.score }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            borderColor: '#f57c00',
            backgroundColor: 'rgba(245, 124, 0, 0.1)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                suggestedMax: 130
            }
        }
    }
});
{% endif %}

// Nutrition Charts
{% if diet_data.current_plan.daily_totals %}
const calorieCtx = document.getElementById('calorieChart').getContext('2d');
const calorieChart = new Chart(calorieCtx, {
    type: 'bar',
    data: {
        labels: [{% for date_key, day_data in diet_data.current_plan.daily_totals.items %}'{{ date_key|slice:"5:" }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Calories',
            data: [{% for date_key, day_data in diet_data.current_plan.daily_totals.items %}{{ day_data.calories|floatformat:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: '#28a745',
            borderColor: '#28a745',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Daily Macronutrient Breakdown (stacked bar)
const dailyMacrosCtx = document.getElementById('dailyMacrosChart').getContext('2d');
const macroLabels = [{% for date_key, day_data in diet_data.current_plan.daily_totals.items %}'{{ date_key|date_ymd }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
const proteinData = [{% for date_key, day_data in diet_data.current_plan.daily_totals.items %}{{ day_data.protein|floatformat:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
const carbsData = [{% for date_key, day_data in diet_data.current_plan.daily_totals.items %}{{ day_data.carbs|floatformat:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
const fatData = [{% for date_key, day_data in diet_data.current_plan.daily_totals.items %}{{ day_data.fat|floatformat:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
const dailyMacrosChart = new Chart(dailyMacrosCtx, {
    type: 'bar',
    data: {
        labels: macroLabels,
        datasets: [
            { label: 'Protein', data: proteinData, backgroundColor: '#1976d2' },
            { label: 'Carbs', data: carbsData, backgroundColor: '#28a745' },
            { label: 'Fat', data: fatData, backgroundColor: '#f57c00' }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } },
        scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true }
        }
    }
});

// Macro distribution chart (sample data - you can expand this)
const macroCtx = document.getElementById('macroChart').getContext('2d');
const macroChart = new Chart(macroCtx, {
    type: 'doughnut',
    data: {
        labels: ['Protein', 'Carbs', 'Fat'],
        datasets: [{
            data: [
                {% if diet_data.nutrition_adherence.daily_target_protein %}{{ diet_data.nutrition_adherence.daily_target_protein }}{% else %}50{% endif %},
                {% if diet_data.nutrition_adherence.daily_target_carbs %}{{ diet_data.nutrition_adherence.daily_target_carbs }}{% else %}250{% endif %},
                {% if diet_data.nutrition_adherence.daily_target_fat %}{{ diet_data.nutrition_adherence.daily_target_fat }}{% else %}70{% endif %}
            ],
            backgroundColor: ['#1976d2', '#28a745', '#f57c00'],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
{% endif %}
</script> 